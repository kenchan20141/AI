<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡è€å¸«çš„æ•‘æ˜Ÿ</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 15px 0;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        select, textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            vertical-align: top;
            word-break: break-word;
        }
        th {
            background: #f0f0f0;
        }
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        .table-container table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-container th, .table-container td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            vertical-align: top;
            word-break: break-word;
        }
        .table-container th:first-child, .table-container td:first-child {
            min-width: 50px;
        }
        .table-container th:nth-child(2), .table-container td:nth-child(2),
        .table-container th:nth-child(3), .table-container td:nth-child(3) {
            min-width: 100px;
        }
        .table-container th:nth-child(4), .table-container td:nth-child(4),
        .table-container th:nth-child(5), .table-container td:nth-child(5) {
            min-width: 150px;
        }
        #writingBtn {
            background-color: #007bff;
        }
        #readingBtn {
            background-color: #28a745;
        }
        #booksBtn {
            background-color: #ffc107;
        }
        #expandBtn {
            background-color: #dc3545;
        }
        #writingBtn:hover {
            background-color: #0056b3;
        }
        #readingBtn:hover {
            background-color: #218838;
        }
        #booksBtn:hover {
            background-color: #e0a800;
        }
        #expandBtn:hover {
            background-color: #c82333;
        }
        #chatHistory {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .user-message {
            text-align: right;
            color: blue;
            margin: 5px 0;
            padding: 5px;
            background-color: #e6f7ff;
            border-radius: 5px;
        }
        .ai-message {
            text-align: left;
            color: green;
            margin: 5px 0;
            padding: 5px;
            background-color: #f0fff0;
            border-radius: 5px;
        }
        #writingContainer, #readingContainer, #booksContainer, #expandContainer {
            display: none;
        }
        #expandTopicSelectionArea {
            margin-top: 10px;
        }
        #expandCustomTopicArea {
            display: none;
        }
        #expandWritingArea {
            margin-top: 10px;
        }
        #expandCommentResult, #expandGuideResult {
            margin-top: 10px;
        }
        #expandGuideArea {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ä¸­æ–‡è€å¸«çš„æ•‘æ˜Ÿ</h1>

    <!-- å·¥å…·åŠŸèƒ½æ¦‚è¦½ -->
    <div class="box">
        <h2>å·¥å…·åŠŸèƒ½æ¦‚è¦½</h2>
        <p>æœ¬å·¥å…·æ—¨åœ¨å”åŠ©åŒå­¸ç·´ç¿’å¯«ä½œå·å’Œé–±è®€å·ï¼Œä¸¦æä¾›èª²å¤–æ›¸ç±è¨è«–ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦åŠŸèƒ½ï¼š</p>
        <ul>
            <li><strong>å¯«ä½œï¼š</strong>æä¾›ç‰‡æ®µæå¯«/å…¨æ–‡å¯«ä½œã€å¤§ç¶±çš„ç·´ç¿’åŠæ•˜äº‹ç‰©è±¡æŒ‡å¼•ï¼Œå¯é¸æ“‡ç”Ÿæˆæˆ–è‡ªè¨‚é¡Œç›®ï¼Œä¸¦ç²å–AIé»è©•å’Œå»ºè­°ã€‚</li>
            <li><strong>é–±è®€ï¼š</strong>æä¾›é»è©•å’ŒæŒ‡å¼•åŠŸèƒ½ï¼Œå¯è²¼ä¸Šé–±è®€ç¯‡ç« å’Œé¡Œç›®ï¼Œç²å–AIçš„é»è©•æˆ–ç­”é¡ŒæŒ‡å¼•ã€‚</li>
            <li><strong>èª²å¤–æ›¸ç±ï¼š</strong>æä¾›AIèŠå¤©å®¤ï¼Œèˆ‡AIè¨è«–èª²å¤–æ›¸ç±ï¼Œå¼•å°æ·±å…¥æ€è€ƒã€‚</li>
            <li><strong>æ•´åˆæ‹“å±•ï¼š</strong>æä¾›é»è©•å’ŒæŒ‡å¼•åŠŸèƒ½ï¼Œå¯é¸æ“‡ç”Ÿæˆæˆ–è‡ªè¨‚é¡Œç›®ï¼Œä¸¦ç²å–AIçš„é»è©•ã€å»ºè­°å’Œæ”¹å¯«ã€‚</li>
        </ul>
    </div>

    <!-- ç¯„ç–‡é¸æ“‡ -->
    <div class="box">
        <h2>é¸æ“‡ç·´ç¿’ç¯„ç–‡ï¼š</h2>
        <button id="writingBtn">å¯«ä½œ</button>
        <button id="readingBtn">é–±è®€</button>
        <button id="booksBtn">èª²å¤–æ›¸ç±</button>
        <button id="expandBtn">æ•´åˆæ‹“å±•</button>
    </div>

    <!-- å¯«ä½œå®¹å™¨ -->
    <div id="writingContainer" class="box">
        <label for="writingType">é¸æ“‡å¯«ä½œé¡å‹ï¼š</label>
        <select id="writingType" onchange="toggleWritingType()">
            <option value="ç‰‡æ®µæå¯«">ç‰‡æ®µæå¯«/å…¨æ–‡å¯«ä½œ</option>
            <option value="å¤§ç¶±">å¤§ç¶±</option>
            <option value="æ•˜äº‹ç‰©è±¡">æ•˜äº‹ç‰©è±¡</option>
        </select>
        <div id="outlineStructureArea">
            <label for="structure">é¸æ“‡å¤§ç¶±çµæ§‹ï¼š</label>
            <select id="structure" onchange="generateOutlineTable()">
                <option value="fourPart">èµ·æ‰¿è½‰åˆ</option>
                <option value="threeLine">ä¸‰ç·š</option>
            </select>
        </div>
        <div id="topicSelectionArea">
            <label for="topicOption">é¸æ“‡é¡Œç›®æ–¹å¼ï¼š</label>
            <select id="topicOption" onchange="toggleTopicInput()">
                <option value="generate">ç”Ÿæˆé¡Œç›®</option>
                <option value="custom">è‡ªè¨‚é¡Œç›®</option>
            </select>
            <div id="generateTopicArea">
                <button onclick="generateTopic()">ç”Ÿæˆå¯«ä½œé¡Œç›®</button>
            </div>
            <div id="customTopicArea" style="display: none;"></div>
            <div id="topicResult"></div>
        </div>
        <div id="narrativeElementsArea">
            <label for="narrativeElements">è«‹è¼¸å…¥æ‚¨çš„å–ææˆ–æ•…äº‹èƒŒæ™¯ï¼š</label>
            <textarea id="narrativeElements" rows="5" placeholder="ä¾‹å¦‚ï¼šæ•…äº‹èƒŒæ™¯ã€äººç‰©è¨­å®šã€å–æç­‰..."></textarea>
        </div>
        <div id="writingArea">
            <div id="outlineTableArea"></div>
            <textarea id="writingContent" rows="10" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å¯«ä½œå…§å®¹ï¼ˆã€Œç‰‡æ®µæå¯«ã€ä½¿ç”¨ï¼‰..."></textarea>
            <label for="writingTone" id="writingToneLabel">é¸æ“‡é»è©•èªæ°£ï¼š</label>
            <select id="writingTone">
                <option value="serious">åš´è‚…æ­£ç¶“</option>
                <option value="chen">é™³SIRèªæ°£</option>
            </select>
            <button onclick="submitWriting()">æäº¤</button>
            <div id="commentResult"></div>
        </div>
    </div>

    <!-- é–±è®€å®¹å™¨ -->
    <div id="readingContainer" class="box">
        <label for="readingFunction">é¸æ“‡é–±è®€åŠŸèƒ½ï¼š</label>
        <select id="readingFunction" onchange="toggleReadingFunction()">
            <option value="comment">é»è©•</option>
            <option value="guide">æŒ‡å¼•</option>
        </select>
        <div id="readingInputArea">
            <label for="readingPassage">è²¼ä¸Šé–±è®€ç¯‡ç« ï¼š</label>
            <textarea id="readingPassage" rows="10" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé–±è®€ç¯‡ç« ..."></textarea>
            <label for="readingQuestion">è²¼ä¸Šé¡Œç›®ï¼š</label>
            <textarea id="readingQuestion" rows="3" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé¡Œç›®..."></textarea>
            <div id="studentAnswerArea" style="display: none;">
                <label for="studentAnswer">è²¼ä¸Šç­”æ¡ˆï¼š</label>
                <textarea id="studentAnswer" rows="5" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šç­”æ¡ˆ..."></textarea>
            </div>
            <label for="readingTone" id="readingToneLabel" style="display: none;">é¸æ“‡é»è©•èªæ°£ï¼š</label>
            <select id="readingTone" style="display: none;">
                <option value="serious">åš´è‚…æ­£ç¶“</option>
                <option value="chen">é™³SIRèªæ°£</option>
            </select>
            <button onclick="submitReading()">æäº¤</button>
            <div id="readingResult"></div>
        </div>
    </div>

    <!-- èª²å¤–æ›¸ç±å®¹å™¨ -->
    <div id="booksContainer" class="box">
        <h2>èª²å¤–æ›¸ç±è¨è«–</h2>
        <p>è«‹åœ¨ä¸‹æ–¹å¡«å¯«æ›¸åã€ä½œè€…å’Œè¨è«–å•é¡Œï¼Œé–‹å§‹èˆ‡é™³SIRå°è©±ï¼š</p>
        <input type="text" id="bookTitle" placeholder="æ›¸å">
        <input type="text" id="author" placeholder="ä½œè€…">
        <textarea id="discussionQuestion" rows="3" placeholder="è¨è«–å•é¡Œ"></textarea>
        <label for="booksTone">é¸æ“‡èªæ°£ï¼š</label>
        <select id="booksTone">
            <option value="casual">è¼•é¬†æ´»æ½‘</option>
            <option value="serious">åš´è‚…æ­£ç¶“</option>
        </select>
        <button onclick="startDiscussion()">é–‹å§‹è¨è«–</button>
        <div id="chatHistory"></div>
        <textarea id="userInput" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰..." style="display: none;"></textarea>
        <button id="continueBtn" onclick="continueDiscussion()" style="display: none;">ç¹¼çºŒè¨è«–</button>
        <button onclick="saveChat()">å„²å­˜å°è©±</button>
        <button onclick="clearChat()">æ¸…ç©ºå°è©±</button>
    </div>

    <!-- æ•´åˆæ‹“å±•å®¹å™¨ -->
    <div id="expandContainer" class="box">
        <h2>æ•´åˆæ‹“å±•</h2>
        <label for="expandFunction">é¸æ“‡åŠŸèƒ½ï¼š</label>
        <select id="expandFunction" onchange="toggleExpandFunction()">
            <option value="comment">é»è©•</option>
            <option value="guide">æŒ‡å¼•</option>
        </select>
        <div id="expandTopicSelectionArea">
            <label for="expandTopicOption">é¸æ“‡é¡Œç›®æ–¹å¼ï¼š</label>
            <select id="expandTopicOption" onchange="toggleExpandTopicInput()">
                <option value="generate">ç”Ÿæˆé¡Œç›®</option>
                <option value="custom">è‡ªè¨‚é¡Œç›®</option>
            </select>
            <div id="expandGenerateTopicArea">
                <button onclick="generateExpandTopic()">ç”Ÿæˆé¡Œç›®</button>
            </div>
            <div id="expandCustomTopicArea" style="display: none;">
                <table>
                    <tr><th>é¡Œç›®</th><td><input type="text" id="expandCustomTitle" placeholder="è«‹è¼¸å…¥é¡Œç›®"></td></tr>
                    <tr><th>ä¸»é¡Œå¥</th><td><textarea id="expandCustomTheme" rows="2" placeholder="è«‹è¼¸å…¥ä¸»é¡Œå¥"></textarea></td></tr>
                    <tr><th>æŠ„éŒ„è³‡æ–™</th><td><textarea id="expandCustomData" rows="3" placeholder="è«‹è¼¸å…¥æŠ„éŒ„è³‡æ–™"></textarea></td></tr>
                </table>
                <button onclick="setExpandCustomTopic()">ç¢ºèªé¡Œç›®</button>
            </div>
            <div id="expandTopicResult"></div>
        </div>
        <div id="expandWritingArea">
            <label for="expandContent">æ•´åˆæ‹“å±•ï¼ˆæœ€å¤š180å­—ï¼‰ï¼š</label>
            <textarea id="expandContent" rows="5" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ•´åˆæ‹“å±•å…§å®¹..." oninput="updateCharCount()"></textarea>
            <p id="charCount">å‰©é¤˜å­—æ•¸ï¼š180</p>
            <label for="expandTone" id="expandToneLabel">é¸æ“‡é»è©•èªæ°£ï¼š</label>
            <select id="expandTone">
                <option value="serious">åš´è‚…æ­£ç¶“</option>
                <option value="chen">é™³SIRèªæ°£</option>
            </select>
            <button onclick="submitExpand()">æäº¤</button>
            <div id="expandCommentResult"></div>
        </div>
        <div id="expandGuideArea">
            <table>
                <tr><th>é¡Œç›®</th><td><input type="text" id="expandGuideTitle" placeholder="è«‹è¼¸å…¥é¡Œç›®"></td></tr>
                <tr><th>ä¸»é¡Œå¥</th><td><textarea id="expandGuideTheme" rows="2" placeholder="è«‹è¼¸å…¥ä¸»é¡Œå¥"></textarea></td></tr>
                <tr><th>æŠ„éŒ„è³‡æ–™</th><td><textarea id="expandGuideData" rows="3" placeholder="è«‹è¼¸å…¥æŠ„éŒ„è³‡æ–™"></textarea></td></tr>
                <tr><th>æ•´åˆæ‹“å±•</th><td><textarea id="expandGuideExpand" rows="3" placeholder="è«‹è¼¸å…¥æ•´åˆæ‹“å±•"></textarea></td></tr>
            </table>
            <button onclick="submitExpand()">æäº¤</button>
            <div id="expandGuideResult"></div>
        </div>
    </div>

    <script>
        // API é…ç½®ä¿¡æ¯
        const API_KEYS = [
            "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",
            "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",
            "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"
        ];
        let currentApiKeyIndex = 0;
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const MODEL = "deepseek/deepseek-r1:free";

        // é è¨­é¡Œç›®åˆ—è¡¨
        const topics = [
            "æ—è§€",
            "èˆå°",
            "é€™ä»¶ç‰©ä»¶å¾ˆæ˜¯è¼•å·§ï¼Œå»è®“æˆ‘æ˜ç™½ã€ä½†æ±‚ç„¡æ„§æ–¼å¿ƒã€çš„é“ç†ã€‚",
            "å±±é ‚",
            "ç¨®å­",
            "æ ¹",
            "ç–¤ç—•",
            "ä»Šå¤©ï¼Œæˆ‘ä¸èƒ½åƒè³½ï¼Œåªèƒ½ååœ¨è§€çœ¾å¸­ä¸Šï¼Œä½†ç•¶æ™‚çš„æ‰€è¦‹æ‰€èå»çµ¦äºˆæˆ‘å¶„æ–°çš„é«”æœƒã€‚",
            "å¾ä»Šä»¥å¾Œï¼Œæˆ‘ä¸æœƒå†è¼•è¨€æ”¾æ£„ã€‚",
            "ç­‰å€™",
            "æˆ‘æ›¾ç¶“åŠªåŠ›å˜—è©¦ï¼Œä½†æœ€çµ‚ä»æ˜¯äº‹èˆ‡é¡˜é•",
            "å›æ†¶",
            "å¾¹å¤œé›£çœ ",
            "å½©è™¹",
            "æ˜Ÿç©ºä¸‹ï¼Œçœ¼å‰çš„æ™¯è±¡è®“æˆ‘æƒ³èµ·é‚£æ®µå¾€äº‹ï¼Œä»¤æˆ‘ä¸ç¦æ­äº†ä¸€å£æ°£â€¦â€¦",
            "è·¯ç‰Œ",
            "ä»Šå­¸å¹´æœ€å¾Œæ‚”çš„ä¸€ä»¶äº‹",
            "æœ€ä»¤æˆ‘æ„Ÿå‹•çš„ä¸€å¥è©±",
            "å†è©¦ä¸€æ¬¡",
            "ä»Šå¤©å†æ¬¡åœ¨å°ä¸Šæ¼”å¥ï¼Œæˆ‘å·²ç¶“è„«èƒæ›éª¨ï¼Œä¸å†æ˜¯å¾å‰é‚£å€‹é©•å‚²è‡ªæ»¿çš„æˆ‘äº†ã€‚",
            "æ¯æ¬¡ç¶“éé€™æ¢è¡—ï¼Œçœ‹ç€è¡—ä¸Šçš„æ™¯ç‰©ï¼Œæˆ‘ä¾¿æ„Ÿè§¸ä¸å·²â€¦â€¦",
            "æ„å¤–",
            "é‘°åŒ™",
            "éŒ¯éäº†çš„æ©Ÿæœƒ",
            "é‚£å¥è©±ï¼Œæˆ‘å¯¦åœ¨ä¸è©²èªªâ€¦â€¦",
            "è‰²å½©",
            "ç…™ç«",
            "è—¥",
            "æ”¾ä¸‹",
            "è¿½é€",
            "åŸä¾†ï¼Œé€™åªæ˜¯ä¸€å ´èª¤æœƒ",
            "ç¼ºæ†¾",
            "ç„¡æ‚”çš„æŠ‰æ“‡",
            "å‹‡æ°£",
            "å‚˜",
            "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ˜ç™½åˆ°åŸä¾†çˆ¶æ¯çš„æ„›ç¸½æ˜¯é«”ç¾åœ¨å°äº‹ä¸Šã€‚",
            "ä¸€ä»¶ä»¤æˆ‘å¾Œæ‚”ä¸å·²çš„äº‹",
            "ä¸€æ¬¡å°·å°¬çš„ç¶“æ­·",
            "æ²¿é€”æœ‰ä½ ",
            "é€™ä¸€æ¬¡ï¼Œæˆ‘å¯¦åœ¨æ„Ÿåˆ°ç„¡åœ°è‡ªå®¹ã€‚",
            "é€™ä¸€æ¬¡ï¼Œæˆ‘æ˜ç™½åˆ°ï¼ŒåŸä¾†å¹«åŠ©ä»–äººçš„åŒæ™‚ï¼Œä¹Ÿå¹«åŠ©äº†è‡ªå·±ã€‚",
            "æˆ‘çš„é„°å±…å¼µå…ˆç”Ÿæ˜¯ä¸€ä½å¾ˆè‹›åˆ»çš„äººï¼Œç¶“å¸¸æœƒç‚ºäº›ã€å°äº‹ã€è€ŒæŠ•è¨´ä»–äººã€‚ä½†ä»Šå¤©æˆ‘ç™¼ç¾ï¼Œä»–é€™æ¨£åšæ˜¯æœ‰åŸå› çš„â€¦â€¦",
            "ç¨è™•çš„ä¸€å¤©",
            "é€™ä¸€åˆ»ï¼Œæˆ‘çµ‚æ–¼èˆ’äº†ä¸€å£æ°£ã€‚",
            "è¨˜ä¸€æ¬¡è¢«èª¤è§£çš„ç¶“æ­·",
            "ä¸€æ¬¡èˆ‡åˆ¥äººè¨€æ­¸æ–¼å¥½çš„ç¶“æ­·",
            "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ„Ÿåˆ°è‡ªå·±çœŸçš„é•·å¤§äº†ã€‚",
            "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ˜ç™½åˆ°å¹¸ç¦åŸä¾†å¯ä»¥å¾ˆç°¡å–®ã€‚",
            "è¨˜ä¸€æ¬¡è‹¦ç›¡ç”˜ä¾†çš„ç¶“æ­·ã€‚",
            "é€™ä»¶äº‹è®“æˆ‘é«”æœƒåˆ°å–œå‡ºæœ›å¤–çš„æ»‹å‘³ã€‚",
            "è·¯æ¨™",
            "è¶³å°",
            "éºæ†¾",
            "é–",
            "é¢å…·",
            "å¿ƒçµ",
            "é–€",
            "å½±å­",
            "ç¦å€",
            "ç­‰å¾…",
            "æ ¹",
            "æœ€å¾Œï¼Œæˆ‘é¸æ“‡äº†æ”¾æ£„",
            "è‡ªé‚£ä¸€åˆ»ï¼Œæˆ‘è§£é–‹äº†å¿ƒçµ",
            "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ˜ç™½çŒ¶è±«æœƒä½¿äººä¸€äº‹ç„¡æˆã€‚",
            "åŸä¾†æˆ‘æ²’æœ‰å¿˜è¨˜é‚£ä¸€é “é£¯ã€‚",
            "æˆ‘åœ¨å¤§è‡ªç„¶ä¹‹ä¸­æ‰¾åˆ°å¿«æ¨‚ã€‚",
            "ç†±é¬§éå¾Œï¼Œæˆ‘å»æ„Ÿåˆ°å¤±è½ã€‚",
            "çœ‹è‘—é€æ¼¸é å»çš„èƒŒå½±ï¼Œæˆ‘æ„Ÿåˆ°å¾ˆå…§ç–šã€‚",
            "ä»Šå¤©æˆ‘æµæ·šäº†ï¼Œä½†æˆ‘ä¸¦éæ„Ÿåˆ°é›£éã€‚",
            "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘æ‰¾åˆ°äº†å‹•åŠ›",
            "ç¶“æ­·äº†é€™æ¬¡é¢¨æ³¢ï¼Œæˆ‘é•·å¤§äº†ã€‚",
            "ç¶“éé€™ä»¶äº‹ï¼Œæˆ‘æ‰æ˜ç™½åˆ°ä¸€å¿ƒæ˜¯æˆ‘çš„çŸ¥å·±ï¼Œæ˜¯çœŸæ­£äº†è§£æˆ‘çš„äººã€‚",
            "è‡ªæ­¤ä¹‹å¾Œï¼Œæˆ‘å­¸æœƒæ”¾ä¸‹ç„¡è¬‚çš„é¢å­ã€‚",
            "é€™ä¸€æ¬¡ï¼Œæˆ‘å†æ²’æœ‰éºæ†¾",
            "é‡éŠèˆŠåœ°æ‰€è¦‹æœ‰æ„Ÿ",
            "å¤±è€Œå¾©å¾—",
            "é€™æ¢è¡—é›–ç„¶è€èˆŠï¼Œä½†å»å……æ»¿äººæƒ…å‘³ã€‚",
            "é€™å¥è©±ï¼Œæˆ‘æœƒè¨˜ä¸Šä¸€è¼©å­ã€‚",
            "é–€",
            "ä¾†æ—¥æ–¹é•·",
            "å¾—ä¸å„Ÿå¤±",
            "éš±è—",
            "å¾®ç¬‘ä»¥å°",
            "ç†±é¬§éå¾Œï¼Œæˆ‘å»æ„Ÿåˆ°å¤±è½ã€‚",
            "å¤¢æƒ³çœ‹ä¼¼ä¸åˆ‡å¯¦éš›ï¼Œä½†å…¶å¯¦å¾ˆæœ‰æ„ç¾©",
            "å¤¢æƒ³çœ‹ä¼¼å¾ˆæœ‰æ„ç¾©ï¼Œå…¶å¯¦ä¸åˆ‡å¯¦éš›",
            "ä»Šå¤©æˆ‘æ²’æœ‰å¸¶æ‰‹æé›»è©±å¤–å‡ºï¼Œå› è€Œæœ‰ä¸ä¸€æ¨£çš„ç¶“æ­·å’Œé«”æœƒã€‚",
            "ä»Šå¤©ç™¼ç”Ÿäº†ä¸€ä»¶äº‹æƒ…ï¼Œç•¶æ™‚æˆ‘æ›¾ç¶“æƒ³åŠ›é™³å·±è¦‹ï¼Œæœ€å¾Œé¸æ“‡äº†æ²‰é»˜ã€‚æˆ‘èªç‚ºæ²‰é»˜æ˜¯å¿…è¦çš„ã€‚",
            "çŸ›ç›¾",
            "æœªå…Œç¾çš„è«¾è¨€",
            "æœªå¯„å‡ºçš„ä¿¡",
            "è·é›¢",
            "ä¸€å ´æ²’æœ‰å¤±æ•—è€…çš„æ¯”è³½",
            "ä¸€ä»¶ç™¼äººæ·±çœçš„äº‹",
            "æˆ‘æœ€æƒ³ä¿ç•™çš„ä¸€æœ¬ç›¸ç°¿",
            "æˆ‘æœ€æƒ³å°‹å›çš„ä¸€ä»¶ç©å…·",
            "ç„¡æ„§çš„æŠ‰æ“‡",
            "ä¸èƒ½æ‰ä¸‹çš„çœ¼æ·š",
            "ç„¡ç•çš„æ¢ç´¢",
            "ä¸€æ¬¡ä»¤æˆ‘ç™¾æ„Ÿäº¤é›†çš„èšé¤",
            "å¦‚é¡˜ä»¥å„Ÿ"
        ];

        let lastTopic = localStorage.getItem("lastTopic") || "";

        // ç¯„ç–‡å®šç¾©
        const categories = {
            "ç‰‡æ®µæå¯«": {
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œå¿…é ˆå°±ä¸Šè¿°ç”Ÿæˆæˆ–è¼¸å…¥çš„é¡Œç›®ã€çµæ§‹æ®µé‡é»ã€æƒ…ç¯€å¤§è¦ï¼Œé»è©•å¤§ç¶±å…§å®¹æ˜¯å¦æ‰£é¡Œã€‚å¿…é ˆå¾ä»¥ä¸‹å…©å€‹è§’åº¦é»è©•ï¼šå…¶ä¸€ï¼Œé»è©•ã€Œçµæ§‹æ®µé‡é»èˆ‡é¡Œç›®æ˜¯å¦æœ‰é—œã€æœ‰å¤šå¤§é‚è¼¯é—œä¿‚ã€ï¼›å…¶äºŒï¼Œé»è©•ã€Œæƒ…ç¯€å¤§è¦æ˜¯å¦èƒ½çªé¡¯å‡ºçµæ§‹æ®µé‡é»ã€å¯«ä½œå…§å®¹çš„è©³ç•¥å‰ªè£æ˜¯å¦æ°ç•¶ï¼Œå³æ˜¯å¦æœ‰æ•ˆçªé¡¯çµæ§‹æ®µé‡é»ï¼ˆå‰ææ˜¯çµæ§‹æ®µé‡é»æ‰£é¡Œï¼Œå¦‚ä¸æ‰£é¡Œï¼Œæƒ…ç¯€å¤§è¦åŠå¯«ä½œå…§å®¹å°±è‚¯å®šä¸æ‰£é¡Œï¼‰ï¼Œé»è©•æ™‚è¦æ³¨æ„å¯«ä½œå…§å®¹ã€çµæ§‹æ®µé‡é»å…©è€…èˆ‡é¡Œç›®æœ‰æ²’æœ‰åœ¨é¡¯æ€§çš„é‚è¼¯é—œä¿‚ï¼Œå¯«ä½œå…§å®¹è¦æ±‚çš„ä¸åªæ˜¯å–ææƒ…ç¯€å¯ä»¥èˆ‡çµæ§‹æ®µé‡é»åŠé¡Œç›®æ§‹æˆé‚è¼¯é—œä¿‚ï¼Œæ›´è¦ç”¨åˆé©çš„æƒ…ç¯€è©³ç•¥å‰ªè£å’Œæ‰£é¡Œå°æ®µå»çªé¡¯èˆ‡è©²éƒ¨ä»½çš„é‚è¼¯é—œä¿‚ï¼Œä½¿å¯«ä½œå…§å®¹æ˜ç¢ºå‘¼æ‡‰çµæ§‹æ®µé‡é»åŠé¡Œç›®ã€‚ã€è‹¥é›¢é¡Œï¼Œç¯„ä¾‹ä¸å¿…æ ¹æ“šåŸæ–‡é›¢é¡Œå…§å®¹æ”¹å¯«ï¼Œè€Œæ”¹å¯«éƒ¨ä»½å¿…é ˆåŒ…å«æ‰£é¡Œå°æ®µï¼ˆéƒ¨ä»½å¥å­ç›´æ¥å‘¼æ‡‰çµæ§‹æ®µé‡é»æˆ–é¡Œç›®ï¼‰ã€‚é»è©•åˆ†ç‚ºä¸‰éƒ¨åˆ†ï¼š### é»è©•ã€### å»ºè­°ã€### æ”¹å¯«ç¯„ä¾‹ã€‚åªé¸å–æœ€é‡è¦çš„ä¸€è‡³å…©é»è©•è«–ï¼Œæ‡‰å…ˆèšç„¦åœ¨è©•è«–å¯«ä½œå…§å®¹æ˜¯å¦åœ¨æ‰£é€£é¡Œç›®åŠçµæ§‹æ®µé‡é»çš„æ–¹å‘ä»¥åŠå…¶è©³ç•¥å‰ªè£ï¼Œå…¶æ¬¡æ–¹ç‚ºæ–‡å¥ï¼ˆåŒ…æ‹¬ç¤ºç¾æ•˜äº‹å’Œå¯†åº¦ï¼‰ã€‚è‹¥çµæ§‹æ®µé‡é»æˆ–æƒ…ç¯€å¤§è¦èˆ‡é¡Œç›®é—œä¿‚è–„å¼±ï¼Œé ˆåœ¨é»è©•ä¸­æŒ‡å‡ºä¸¦é‡é»èªªæ˜ã€‚é»è©•å…§å®¹è¦ç²¾ç°¡ã€ä¸€èªä¸­çš„ï¼Œåƒ…å°‡æœ€é—œéµã€å½±éŸ¿æœ€å¤§çš„ä¸€è‡³å…©é …è©•èªé»å‡ºä¾†ï¼Œè‹¥æ‰£é¡Œå’Œè©³ç•¥å‰ªè£ç­‰éƒ½è™•ç†ä¸å¾—ç•¶ï¼Œå‰‡ä¸éœ€è¦è©³è©•æ–‡å¥ã€‚ç‰‡æ®µæå¯«éœ€äº¤æ›¿é‹ç”¨å°ç‰©ä»¶ã€å‹•ä½œã€å°è©±å’Œå…§å¿ƒç¨ç™½ï¼Œæé«˜æ–‡å¥å¯†åº¦ï¼ˆè©åŒ¯æ·±åº¦é«˜ã€ç‰©è±¡è±å¯Œã€å¯¦è©æ¯”ä¾‹é«˜ï¼‰ï¼Œä½†å¿…é ˆæ³¨æ„ï¼šéçŒ¶ä¸åŠï¼Œä¸è¦é€£ç”¨å°ç‰©ä»¶åšä¸»èªçš„å¥å­ï¼Œé©æ™‚éœ€è¦ä»¥äººç‰©ä½œä¸»èªï¼Œäº¤æ›¿å»ç”¨ï¼Œæœ‰æ™‚åŠ å…¥å…§å¿ƒç¨ç™½æœƒä»¤æ–‡å¥é¡¯å¾—æ›´è‡ªç„¶ï¼Œå¯†åº¦ä¸å®œéé«˜ï¼Œé©æ™‚è¦åŠ å…¥è™›è©æ”¾ç·©ç¯€å¥ï¼Œå¼µå¼›æœ‰åº¦ã€‚æ­¤å¤–ï¼Œè¦æ§åˆ¶è©³ç•¥ç¯€å¥ï¼Œè©³å¯«èˆ‡é¡Œç›®ç›¸é—œçš„éƒ¨åˆ†ï¼Œç•¥å¯«æ¬¡è¦å…§å®¹ã€‚æ–‡å¥å¯†åº¦ä¹Ÿæ˜¯å¥½æ–‡ç­†çš„æ¨™æº–ï¼Œéœ€ç´å…¥è€ƒé‡ã€‚é»è©•å’Œå»ºè­°ä¸æ‡‰ä½¿ç”¨åˆ—é»å½¢å¼ï¼Œæ‡‰ä»¥æ®µè½å‘ˆç¾ã€‚æ­¤å¤–ï¼Œå‡å¦‚æ•´é«”è¡¨ç¾çœŸçš„ä¸éŒ¯ï¼Œæ²’æœ‰å¤§å•é¡Œï¼Œåœ¨é»è©•æ™‚ç¨±è®šå³å¯ï¼Œä¸å¿…å¹æ¯›æ±‚ç–µåœ°æ‰¹è©•ï¼Œä½†åœ¨å¯«ä½œå…§å®¹çš„ã€Œæ‰£é¡Œã€é‚è¼¯ä¸Šå¿…é ˆåš´è¬¹æŠŠé—œã€‚"
            },
            "å¤§ç¶±": {
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œå¿…é ˆå°±ä¸Šè¿°ç”Ÿæˆçš„é¡Œç›®é»è©•å¤§ç¶±å…§å®¹æ˜¯å¦æ‰£é¡Œï¼Œå‡å¦‚å¤§ç¶±é›¢é¡Œï¼Œç¯„ä¾‹ä¾¿ä¸å¿…æ ¹æ“šé›¢é¡Œå…§å®¹æ”¹å¯«ã€‚æ­¤å¤–ï¼Œé»è©•æ‡‰åˆ†ç‚ºä¸‰å€‹éƒ¨ä»½ï¼šé»è©•ã€å»ºè­°ã€æ”¹å¯«ç¯„ä¾‹ã€‚åœ¨å¯«ä½œå¤§ç¶±æ™‚ï¼Œå­¸ç”Ÿæ‡‰å±•ç¤ºä»–å€‘çµ„ç¹”æ€è·¯å’Œçµæ§‹æ•…äº‹çš„èƒ½åŠ›ã€‚è©•åˆ†æ™‚ï¼Œè«‹æ³¨æ„å¤§ç¶±çš„é‚è¼¯æ€§ã€æ¢ç†æ€§ä»¥åŠæ˜¯å¦åŒ…å«äº†æ•…äº‹çš„èµ·æ‰¿è½‰åˆæˆ–ä¸‰ç·šçµæ§‹ï¼ˆå³æ‰€è¬‚ã€Œæ•£æ•˜ã€ï¼Œæœ‰ä»¥ä¸‹ä¸‰é»è¦æ³¨æ„ï¼šå…¶ä¸€ï¼Œä¸‰ç·šçš„åˆ†é¡ç¯„ç–‡ç›¸åŒï¼›å…¶äºŒï¼Œä¸‰ç·šæˆ–æœ‰å±¤éé—œä¿‚ï¼Œæˆ–èƒ½å¾ä¸‰å€‹è§’åº¦å‘ˆç¾åŒä¸€å€‹ä¸»é¡Œï¼›å…¶ä¸‰ï¼Œä¸‰ç·šçš„æƒ…ç¯€ç™¼å±•ä¸èƒ½éæ–¼ç›¸ä¼¼ï¼›å…¶å››ï¼Œæ‰€åˆ†ä¹‹è§’åº¦èƒ½çªé¡¯èˆ‡ä¸»é¡Œç›¸é—œçš„ç«‹æ„ã€‚ã€Œä¸‰ç·šã€ä¾‹å­å¦‚ä¸‹ï¼šé¡Œç›®ç‚ºã€Œå‹‡æ°£ã€ï¼Œå‰‡å¯ç”¨ã€Œå¹´å°‘æ™‚çš„å‹‡æ°£ã€ç‚ºä¸€ç·šã€ã€Œå¹´é’æ™‚çš„å‹‡æ°£ã€ç‚ºäºŒç·šã€ã€Œå¹´è€æ™‚çš„å‹‡æ°£ã€ç‚ºä¸‰ç·šï¼›åˆå¦‚ä»¥ã€Œé‡éŠèˆŠåœ°æ‰€è¦‹æœ‰æ„Ÿã€ï¼Œå‰‡å¯ç”¨åœ¨æ•…é„‰çš„ä¸åŒã€Œåœ°ã€æ‰€è¦‹ä½œä¸‰ç·šåˆ†é¡ï¼Œä¾‹å¦‚è€å±‹ã€å¾Œå±±ç­‰ã€‚å¿…é ˆç¢ºä¿æ¯æ¢ç·šçš„ã€Œçµæ§‹æ®µé‡é»ã€æ¸…æ™°é»æ˜ä¸‰ç·šçš„åˆ†é¡ç¯„ç–‡ã€æƒ³çªé¡¯é¡Œç›®çš„ç”šéº¼è¦é»ã€èˆ‡é¡Œç›®å¦‚ä½•æ‰£é€£ç­‰ï¼Œä»¥åŠã€Œåˆã€èƒ½çµ±æ”ç¸½çµå…¨æ–‡ç«‹æ„ï¼‰ã€‚è¦é€éƒ¨åˆ†åˆ†ææ¯å€‹çµæ§‹æ®µèˆ‡é¡Œç›®çš„é—œä¿‚æœ‰å¤šå¤§ï¼Œä¸¦åœ¨é»è©•ä¸­æ˜ç¢ºæŒ‡å‡ºã€‚æ­¤å¤–ï¼Œåœ¨ã€Œæ”¹å¯«å¾Œçš„å¤§ç¶±ã€,å…¶ã€Œçµæ§‹æ®µé‡é»ã€å¿…é ˆäº¤ä»£è©²éƒ¨ä»½èˆ‡é¡Œç›®ä¹‹é–“çš„é‚è¼¯é—œä¿‚ï¼Œå³æ€æ¨£åšåˆ°æ‰£é¡Œã€‚æ­¤å¤–ï¼Œç”±æ–¼æ˜¯æ‡‰è©¦æ–‡ç« ï¼Œå› æ­¤æ”¹å¯«å¾Œçš„å¤§ç¶±é¿å…éä»½å…·ç†è«–å“²å­¸æ€§åŠæ–‡å­¸æ€§ï¼Œä»¥è‡³æ–¼è„«é›¢äº†ç¾å¯¦å’Œæ—¥å¸¸ç”Ÿæ´»ï¼Œäº¦åœç¹äººåœ¨ç¶“æ­·çš„æƒ…æ„Ÿå’Œé«”æ‚Ÿè¨­å®šï¼Œå¿…é ˆæ¸›å°‘æ¦‚å¿µæ¨¡ç³Šçš„è¡“èªï¼Œä¾‹å¦‚ã€Œæƒ…æ„Ÿè¼‰é«”ã€åŠã€Œæ™‚ç©ºçš„å…±å‰µã€ï¼Œè«‹ç”¨æ—¥å¸¸åŒ–ç”¨èªæè¿°ã€‚æ­¤å¤–ï¼Œã€Œæ”¹å¯«å¾Œçš„å¤§ç¶±ã€ä¸å®œåªåœç¹ä¸€ä»¶äº‹æ•˜å¯«ï¼Œé€™æ¨£æœƒå®¹æ˜“å¯«å¾—å¤ªæŠ½è±¡ï¼Œæ‡‰é©æ™‚åŠ æ’äººç‰©èˆ‡äººç‰©ä¹‹é–“çš„å›æ†¶æˆ–å…¶ä»–ç¶“æ­·ï¼Œä»¤æ–‡ç« çœ‹èµ·ä¾†æ›´å…·é«”å¯¦åœ¨ã€‚æ­¤å¤–ï¼Œå¤§ç¶±ä¸æ˜¯å…¨ç¯‡æ–‡ç« ï¼Œæœ€é‡è¦çš„æ˜¯åœ¨é»è©•æ™‚åˆ†æå…¶çµæ§‹æ®µåŠæƒ…ç¯€å¤§è¦çš„æ€è·¯æ˜¯å¦æ‰£ç·Šé¡Œç›®ï¼Œæ–¹å‘æ˜¯å¦åˆç†ã€æ­£ç¢ºã€‚å‡å¦‚æ•´é«”è¡¨ç¾çœŸçš„ä¸éŒ¯ï¼Œæ²’æœ‰å¤§å•é¡Œï¼Œåœ¨é»è©•æ™‚ç¨±è®šå³å¯ï¼Œä¸å¿…å¹æ¯›æ±‚ç–µåœ°æ‰¹è©•ã€‚"
            },
            "æ•˜äº‹ç‰©è±¡": {
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚åœ¨ã€Œæ•˜äº‹ç‰©è±¡ã€ä¸­ï¼Œå­¸ç”Ÿéœ€è¦é‹ç”¨è±å¯Œçš„ç‰©è±¡ä¾†å¢å¼·æ•…äº‹çš„ç”Ÿå‹•æ€§å’ŒçœŸå¯¦æ„Ÿã€‚ç‰©è±¡æ‡‰èˆ‡é¡Œç›®ã€å–æå’Œæ•…äº‹èƒŒæ™¯ç·Šå¯†ç›¸é—œï¼Œä¸¦ä¸”èƒ½å¤ æœ‰æ•ˆåœ°è¡¨é”äººç‰©çš„æƒ…æ„Ÿå’Œæ•…äº‹çš„ä¸»é¡Œã€‚è«‹ç¢ºä¿ç”Ÿæˆçš„ç‰©è±¡ä¸é‡è¤‡ï¼Œä¸¦ä¸”æ’ç‰ˆæ¸…æ™°æ˜“è®€ã€‚æ­¤å¤–ï¼Œæ¯å€‹ç‰©è±¡éƒ½å¿…é ˆç”±å…©å€‹å­—æ§‹æˆã€‚"
            },
            "é–±è®€": {
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œéœ€è©•ä¼°ç­”é¡Œæ–¹å‘æ˜¯å¦åˆç†ã€æ–‡æœ¬ä¾æ“šæ˜¯å¦å……å¯¦å…·é«”ã€é—¡é‡‹æ¨è«–æ˜¯å¦åš´è¬¹ã€ä¸»é¡Œå¥æ˜¯å¦æ¸…æ™°ã€‚æ–‡æœ¬ä¾æ“šæ‡‰æ¦‚æ‹¬æ­¸ç´è€Œéç›´æ¥å¼•ç”¨åŸæ–‡ï¼Œé™¤éé¡Œç›®ä¸­æœ‰ã€æ‘˜éŒ„ã€å­—çœ¼ã€‚æ”¹å¯«ç¯„ä¾‹æ‡‰ä½¿ç­”æ¡ˆæ›´åœ“è¶³ï¼Œä½†è‹¥å­¸ç”Ÿç­”é¡Œæ–¹å‘éŒ¯èª¤ï¼Œå‰‡ä¸è·Ÿå¾éŒ¯èª¤æ–¹å‘æ”¹å¯«ã€‚é»è©•ä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸ä½¿ç”¨åˆ—é»ã€‚åœ¨ã€Œæ”¹å¯«ç¯„ä¾‹ã€å‰ï¼ŒåŠ å…¥ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ï¼Œæè¿°å„éƒ¨åˆ†æ–¹å‘ï¼Œæ­¥é©Ÿå› é¡Œåˆ¶å®œï¼Œå¯èƒ½åŒ…æ‹¬ã€é‹ªå¢Šã€‘ã€ã€å›æ‡‰ã€‘ã€ã€æ–‡æœ¬ä¾æ“šã€‘ã€ã€é—¡é‡‹ã€‘ï¼Œéˆæ´»é‹ç”¨ã€‚æ¯å€‹æ­¥é©Ÿä»¥ã€æ­¥é©Ÿåã€‘æ¨™é¡ŒåŠ åˆ†è¡Œå…§å®¹å‘ˆç¾ï¼Œæ’ç‰ˆæ•´é½Šã€‚è¡¨æ ¼ä¸­åªåŒ…å«æ–‡å­—å’Œæ¨™é»ï¼Œä¸å«ã€---ã€ç­‰ç¬¦è™Ÿã€‚",
                guideNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚åƒ…ç”Ÿæˆä¸‰é“å•é¡Œä»¥å¼•å°ç”¨å®¶å›ç­”é–±è®€ç¯‡ç« çš„å•é¡Œï¼Œå•é¡Œé‡å°é¡Œç›®ï¼Œå¼•å°æ€è€ƒæ–‡æœ¬å…§å®¹ã€çµæ§‹å’Œä¸»é¡Œï¼Œä¸å«å…¶ä»–å…§å®¹ã€‚ç”Ÿæˆ15å€‹ç”±å…©å€‹å­—æ§‹æˆçš„ç­”é¡Œè©åŒ¯ï¼Œè©åŒ¯éœ€èˆ‡ç­”é¡Œæ–¹å‘ç›¸é—œä¸”ä¸é‡è¤‡ï¼Œæ—¨åœ¨ä»¤ç”¨å®¶åœ¨ç­”é¡Œæ™‚æœ‰æ›´è±å¯Œçš„è©åŒ¯ï¼Œç¢ºä¿ä¸èƒ½æœ‰ã€Œ|--------|ã€åŠã€Œ| è©åŒ¯ |ã€ï¼Œæ’ç‰ˆæ•´é½Šã€‚è¼¸å‡ºåˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼š### ç­”é¡ŒæŒ‡å¼•ã€### ç­”é¡Œè©åŒ¯ã€‚ç­”é¡ŒæŒ‡å¼•ä»¥å•é¡Œå½¢å¼å‘ˆç¾ï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œã€‚ç­”é¡Œè©åŒ¯ä»¥è¡¨æ ¼å½¢å¼å‘ˆç¾ï¼Œæ¯å€‹è©å ä¸€è¡Œã€‚æ­¤å¤–ï¼Œå‡å¦‚æ•´é«”è¡¨ç¾çœŸçš„ä¸éŒ¯ï¼Œæ²’æœ‰å¤§å•é¡Œï¼Œåœ¨é»è©•æ™‚ç¨±è®šå³å¯ï¼Œä¸å¿…å¹æ¯›æ±‚ç–µåœ°æ‰¹è©•ã€‚"
            },
            "èª²å¤–æ›¸ç±": {
                chatNote: "å¿…é ˆç”¨ç¹é«”å­—ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾å¯ä»¥ç”¨ä¸€ä¸‹ç¶²çµ¡ç”¨èªã€‚"
            },
            "æ•´åˆæ‹“å±•": {
                topicPrompt: "è«‹ç”Ÿæˆä¸€é“é©åˆä¸­å­¸ç”Ÿç·´ç¿’æ•´åˆæ‹“å±•çš„é¡Œç›®ï¼Œé¡Œç›®æ‡‰åŒ…å«ä¸»é¡Œå¥ï¼ˆä¸»é¡Œå¥çµ•å°ä¸èƒ½æ˜¯å•å¥ï¼‰å’ŒæŠ„éŒ„è³‡æ–™ï¼ˆæŠ„éŒ„è³‡æ–™å¿…é ˆä¸åŒ…å«ä»»ä½•æ•¸æ“šï¼Œä¸å¾—åŒ…å«å¼•è™Ÿæˆ–äººç‰©å°è©±ï¼Œè€Œä¸”ä¸å¾—è¶…é30å­—ï¼‰ï¼Œä¸¦ç¬¦åˆä»¥ä¸‹æ–‡é¡å’Œå–æç¯„åœã€‚æ–‡é¡ï¼šæ›¸ä¿¡ã€è©•è«–ã€å»ºè­°æ›¸ã€æ¼”è¬›è¾­ã€å ±å‘Šã€å°ˆé¡Œæ–‡ç« ã€‚å–æç¯„åœï¼šä¾‹å¦‚ç’°ä¿ã€ç¤¾æœƒã€æ–‡åŒ–ã€å­¸ç¿’ç­‰æ´»å‹•ï¼Œä½†å‡ºé¡Œè«‹å¤šå…ƒåŒ–ä¸€é»ï¼Œäº¦ä¸è¦æ¯æ¬¡éƒ½æ˜¯èˆ‡å¥½è™•ç›¸é—œçš„ï¼Œå¦å‰‡ç”¨å®¶å¤šç”Ÿæˆå¹¾æ¬¡ï¼Œä¾¿æœƒé‡åˆ°é¡ä¼¼çš„é¡Œç›®ã€‚è¦æ±‚ï¼š1. ä¸»é¡Œå¥ç°¡æ½”ï¼Œ20å­—ä»¥å…§ã€‚2. æŠ„éŒ„è³‡æ–™ç‚ºä¸€æ®µæ–‡å­—ï¼Œä¸è¶…é100å­—ã€‚3. è¼¸å‡ºæ ¼å¼ç‚ºï¼šä¸»é¡Œå¥ï¼š...\næŠ„éŒ„è³‡æ–™ï¼š...\n4. å…§å®¹ç°¡æ½”æ˜äº†ï¼Œé¿å…å†—é•·ã€‚5. é¡Œç›®å¤šæ¨£åŒ–ï¼Œé¿å…é‡è¤‡ã€‚",
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œéœ€è©•ä¼°ã€Œæ•´åˆæ‹“å±•ã€æ˜¯å¦èƒ½é—¡é‡‹ã€ŒæŠ„éŒ„è³‡æ–™ã€èˆ‡ã€Œä¸»é¡Œå¥ã€çš„é‚è¼¯é—œä¿‚ã€‚éœ€åˆ¤æ–·ï¼š1.ã€Œæ‹“å±•ã€æ–¹å‘æ˜¯å¦æ­£ç¢ºï¼ˆå³æ˜¯å¦èƒ½è«–è­‰ä¸»é¡Œå¥ï¼‰ï¼›2.æ¨è«–æ˜¯å¦åš´è¬¹ï¼›3.æ˜¯å¦å…·é«”ä¸ç©ºæ³›ã€‚ã€Œé»è©•ã€æ™‚ï¼Œè‹¥æ–¹å‘ä¸æ­£ç¢ºï¼Œéœ€æŒ‡å‡ºä¸¦å»ºè­°å¦‚ä½•ä¿®è¨‚ï¼Œéœ€æŒ‡å°ç·Šæ‰£ä¸»é¡Œå¥ï¼Œäº¦é ˆåˆ†æä¸»é¡Œå¥å’Œé¡Œç›®ä»»å‹™çš„é—œä¿‚æ˜¯å¦ç·Šå¯†ï¼Œä¾‹å¦‚é¡Œç›®ä»»å‹™ç‚ºæå‡ºå»ºè­°ï¼Œä½†ä¸»é¡Œå¥ç„¦é»å»æ˜¯æè¿°å•é¡Œï¼Œå‰‡å±¬æ–¼ä¸å¦¥ç•¶ã€‚ã€Œæ”¹å¯«ã€æ™‚äº¦ä¸èƒ½é †è‘—ã€Œæ•´åˆæ‹“å±•ã€éŒ¯èª¤æ€è·¯æ”¹å–„ï¼Œéœ€æ‰£ç·Šä¸»é¡Œå¥ï¼Œå‡å¦‚ä¸»é¡Œå¥æœ¬èº«å°±æœªèƒ½ç·Šæ‰£é¡Œç›®çš„ä»»å‹™ï¼Œå‰‡ä¸æ‡‰åœç¹æœ¬èº«éŒ¯èª¤çš„ä¸»é¡Œå¥æ”¹å¯«ï¼Œè¦åœ¨ã€Œæ”¹å¯«ã€éƒ¨ä»½é‡å°ä¸€å€‹æ­£ç¢ºçš„ä¸»é¡Œå¥ä½œæ”¹å¯«ã€‚æ­¤å¤–ï¼Œæ”¹å¯«éƒ¨ä»½ä¸å®œåˆ†ç‚ºå¤ªå¤šè§’åº¦è«–è¿°ï¼Œé€™æ¨£æœƒä»¤é—¡é‡‹è¼ƒé›¶æ•£ï¼Œé ˆå°±æœ€å¤š2å€‹è§’åº¦æ·±å…¥åˆ†æã€é—¡é‡‹ã€‚æ”¹å¯«éƒ¨ä»½ä¸å¾—è¶…é180å­—ï¼Œä¸”ä¸å¾—è™›æ§‹è³‡æ–™ï¼ŒåŒ…æ‹¬æ•¸æ“šåŠèª¿æŸ¥ï¼Œä¸è¦è‡ªæ“¬ã€Œæ ¹æ“šèª¿æŸ¥ã€ä¹‹é¡ï¼Œåªå¯æ ¹æ“šæŠ„éŒ„è³‡æ–™è£œå……åˆç†ç´°ç¯€ï¼Œã€Œæ”¹å¯«ã€éƒ¨ä»½ä¸è¦é‡è¤‡ç”¨å®¶è¼¸å…¥çš„ã€ŒæŠ„éŒ„è³‡æ–™ã€ï¼Œæœƒç™½ç™½æµªè²»ç©ºé–“ã€‚æ­¤å¤–ï¼Œã€Œæ”¹å¯«ã€äº¦è¦åš´è¬¹å°æ‡‰ä¸»é¡Œå¥åŠæŠ„éŒ„è³‡æ–™é—œä¿‚ï¼Œä¾‹å¦‚ä¸»é¡Œå¥æè¿°æ´»å‹•å•é¡Œï¼Œå‰‡åœ¨ã€Œæ”¹å¯«ã€çš„éƒ¨ä»½ä¸å®œèšç„¦åœ¨æ”¹å–„æªæ–½ï¼Œå¿…é ˆæ³¨æ„è©³ç•¥ã€è¼•é‡ï¼Œæ‰èƒ½çªé¡¯ä¸»é¡Œå¥ã€‚æ­¤å¤–ï¼Œã€Œæ”¹å¯«ã€äº¦è¦ç•™æ„é¡Œç›®ä»»å‹™ï¼Œä¸è¦åœ¨ã€Œæ”¹å¯«ã€æ™‚æœƒé †è‘—ç”¨å®¶è©³ç•¥ä¸ç•¶æˆ–éŒ¯èª¤çš„ã€Œæ•´åˆæ‹“å±•ã€æ€è·¯æ”¹å¯«ã€‚æ­¤å¤–ï¼Œã€Œæ”¹å¯«ã€éƒ¨ä»½ä¸è¦å¤ªæ•¸æ“šåŒ–ï¼Œä¾‹å¦‚åšè¨ˆç®—åŠåˆ†ææ•¸æ“šç­‰ï¼Œé€™éƒ¨ä»½æœ€é‡è¦æ˜¯äº¤ä»£äº‹ç†çš„é‚è¼¯é—œä¿‚ã€‚é»è©•åˆ†ç‚ºä¸‰éƒ¨åˆ†ï¼š### é»è©•ã€### å»ºè­°ã€### æ”¹å¯«ã€‚é»è©•å’Œå»ºè­°ä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸ä½¿ç”¨åˆ—é»ã€‚æ‹“å±•æ–¹æ³•ï¼šä»¥æŠ„éŒ„è³‡æ–™ç‚ºèµ·é»ï¼Œä¸»é¡Œå¥ç‚ºçµ‚é»ï¼Œé‹ç”¨æ©«å‘æ‹“å±•ï¼ˆé€æ­¥æ¨è«–ï¼Œå›ç­”ã€Œç‚ºä½•ã€æˆ–ã€Œå¦‚ä½•ã€ï¼‰æˆ–ç›´å‘æ‹“å±•ï¼ˆè£œå……å…·é«”ä¾‹å­æˆ–ç´°ç¯€ï¼‰ã€‚æ”¹å¯«éƒ¨ä»½å¿…é ˆæ³¨æ„è¦é‹ç”¨å¥½æ©«å‘æ‹“å±•åŠç›´å‘æ‹“å±•çš„æŠ€å·§ã€‚å¸¸è¦‹å•é¡ŒåŒ…æ‹¬ï¼šæ¨è«–æ–¹å‘éŒ¯èª¤ã€æœªæ¨è«–åˆ°åº•ã€æ¨è«–é»é‡è¤‡ã€æ¨è«–è·³è„«ã€æœ‰é‡ç„¡è³ªï¼Œéœ€é‡å°æ€§æŒ‡å‡ºï¼Œæ”¹å¯«æ™‚äº¦è¦é¿å…çŠ¯ä¸‹é€™äº›å•é¡Œã€‚",
                guideNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚åƒ…ç”Ÿæˆä¸‰é“å•é¡Œä»¥å¼•å°ç”¨å®¶æ€è€ƒå¦‚ä½•æ ¹æ“šè¡¨æ ¼è³‡æ–™åšå¥½æ•´åˆæ‹“å±•ï¼Œå•é¡Œæ‡‰åœç¹ä¸»é¡Œå¥å’ŒæŠ„éŒ„è³‡æ–™çš„é‚è¼¯é—œä¿‚ï¼Œå¼•å°ç”¨å®¶æ€è€ƒå¦‚ä½•é—¡é‡‹å’Œæ‹“å±•ã€‚è«‹ä¸è¦é‹ç”¨æ­åŒ–å¥åŠè©åŒ¯ï¼Œä¾‹å¦‚ã€Œé—œè¯æ€§ã€ã€ã€Œå¯¦æ•ˆæ€§ã€ï¼Œé€™äº›å­—è©æ„ç¾©ä¸æ˜ç¢ºï¼Œä½†ç”¨ç”Ÿæ´»åŒ–ä¸€é»ã€å…·é«”ä¸€é»çš„å­—è©ç”Ÿæˆå•é¡Œã€‚è¼¸å‡ºåˆ†ç‚ºä¸€å€‹éƒ¨åˆ†ï¼š### æŒ‡å¼•å•é¡Œã€‚æŒ‡å¼•å•é¡Œä»¥å•é¡Œå½¢å¼å‘ˆç¾ï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œã€‚"
            }
        };

        // ç¯„ç–‡åˆ‡æ›
        document.getElementById("writingBtn").addEventListener("click", function() {
            showContainer("writingContainer");
        });
        document.getElementById("readingBtn").addEventListener("click", function() {
            showContainer("readingContainer");
        });
        document.getElementById("booksBtn").addEventListener("click", function() {
            showContainer("booksContainer");
        });
        document.getElementById("expandBtn").addEventListener("click", function() {
            showContainer("expandContainer");
        });

        function showContainer(containerId) {
            document.getElementById("writingContainer").style.display = "none";
            document.getElementById("readingContainer").style.display = "none";
            document.getElementById("booksContainer").style.display = "none";
            document.getElementById("expandContainer").style.display = "none";
            document.getElementById(containerId).style.display = "block";
            if (containerId === "writingContainer") toggleWritingType();
            if (containerId === "readingContainer") toggleReadingFunction();
            if (containerId === "expandContainer") toggleExpandFunction();
        }

        // åˆ‡æ›å¯«ä½œé¡å‹
        function toggleWritingType() {
            const writingType = document.getElementById("writingType").value;
            const outlineStructureArea = document.getElementById("outlineStructureArea");
            const narrativeElementsArea = document.getElementById("narrativeElementsArea");
            const writingContent = document.getElementById("writingContent");
            const outlineTableArea = document.getElementById("outlineTableArea");
            const writingToneLabel = document.getElementById("writingToneLabel");
            const writingTone = document.getElementById("writingTone");

            if (writingType === "å¤§ç¶±") {
                outlineStructureArea.style.display = "block";
                narrativeElementsArea.style.display = "none";
                writingContent.style.display = "none";
                generateOutlineTable();
                writingToneLabel.style.display = "block";
                writingTone.style.display = "block";
            } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                outlineStructureArea.style.display = "none";
                narrativeElementsArea.style.display = "block";
                writingContent.style.display = "none";
                outlineTableArea.innerHTML = "";
                writingToneLabel.style.display = "none";
                writingTone.style.display = "none";
            } else {
                outlineStructureArea.style.display = "none";
                narrativeElementsArea.style.display = "none";
                writingContent.style.display = "block";
                outlineTableArea.innerHTML = "";
                writingToneLabel.style.display = "block";
                writingTone.style.display = "block";
            }
            toggleTopicInput();
        }

        // ç”Ÿæˆå¤§ç¶±è¡¨æ ¼
        function generateOutlineTable() {
            const structure = document.getElementById("structure").value;
            let parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
            let tableHTML = "<table><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>";
            parts.forEach((part, index) => {
                const focusId = structure + "Focus" + (index + 1);
                const plotId = structure + "Plot" + (index + 1);
                tableHTML += `<tr><td>${part}</td><td><textarea id="${focusId}" rows="3"></textarea></td><td><textarea id="${plotId}" rows="3"></textarea></td></tr>`;
            });
            tableHTML += "</table>";
            tableHTML += `<button onclick="saveOutline()">å„²å­˜</button><button onclick="clearOutline()">æ¸…ç©º</button>`;
            document.getElementById("outlineTableArea").innerHTML = tableHTML;

            // æ¢å¾©ä¿å­˜çš„å…§å®¹
            const savedOutline = JSON.parse(localStorage.getItem("savedOutline") || "{}");
            if (savedOutline.structure === structure) {
                parts.forEach((part, index) => {
                    const focusId = structure + "Focus" + (index + 1);
                    const plotId = structure + "Plot" + (index + 1);
                    document.getElementById(focusId).value = savedOutline[focusId] || "";
                    document.getElementById(plotId).value = savedOutline[plotId] || "";
                });
            }
        }

        // å„²å­˜å¤§ç¶±
        function saveOutline() {
            const structure = document.getElementById("structure").value;
            const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
            const outlineData = { structure };
            parts.forEach((part, index) => {
                const focusId = structure + "Focus" + (index + 1);
                const plotId = structure + "Plot" + (index + 1);
                outlineData[focusId] = document.getElementById(focusId).value;
                outlineData[plotId] = document.getElementById(plotId).value;
            });
            localStorage.setItem("savedOutline", JSON.stringify(outlineData));
            alert("å¤§ç¶±å·²å„²å­˜");
        }

        // æ¸…ç©ºå¤§ç¶±
        function clearOutline() {
            const structure = document.getElementById("structure").value;
            const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
            parts.forEach((part, index) => {
                const focusId = structure + "Focus" + (index + 1);
                const plotId = structure + "Plot" + (index + 1);
                document.getElementById(focusId).value = "";
                document.getElementById(plotId).value = "";
            });
            localStorage.removeItem("savedOutline");
            alert("å¤§ç¶±å·²æ¸…ç©º");
        }

        // èª²å¤–æ›¸ç±éƒ¨åˆ†
        let chatHistory = [];
        let bookTitle = "";
        let author = "";
        let discussionQuestion = "";

        async function startDiscussion() {
            bookTitle = document.getElementById("bookTitle").value.trim();
            author = document.getElementById("author").value.trim();
            discussionQuestion = document.getElementById("discussionQuestion").value.trim();
            if (!bookTitle || !author || !discussionQuestion) {
                alert("è«‹å¡«å¯«æ›¸åã€ä½œè€…å’Œè¨è«–å•é¡Œ");
                return;
            }
            chatHistory = [];
            addMessageToHistory("user", `æ›¸åï¼š${bookTitle}\nä½œè€…ï¼š${author}\nè¨è«–å•é¡Œï¼š${discussionQuestion}`);
            document.getElementById("userInput").style.display = "block";
            document.getElementById("continueBtn").style.display = "block";
            await sendInitialMessage();
        }

        async function sendInitialMessage() {
            const tone = document.getElementById("booksTone").value;
            let toneNote = tone === "casual" ? "è«‹ç”¨è¼•é¬†æ´»æ½‘çš„èªæ°£é€²è¡Œå›æ‡‰ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾ä½¿ç”¨ç¶²çµ¡ç”¨èªï¼Œç”¨èªè¦æ—¥å¸¸ç”Ÿæ´»åŒ–ä¸€é»ã€‚" : "è«‹ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£é€²è¡Œå›æ‡‰ï¼Œç”¨èªè²¼è¿‘æ—¥å¸¸ç”Ÿæ´»ï¼Œå›æ‡‰ä¸è¦ç†è«–åŒ–ï¼Œä¸ç”¨ç¶²çµ¡ç”¨èªï¼Œä¸ç”¨EMOJIã€‚";
            const prompt = `æˆ‘æ˜¯ä¸€ä½é«˜ä¸­ç”Ÿï¼Œæ­£åœ¨é–±è®€ã€Š${bookTitle}ã€‹ï¼Œä½œè€…æ˜¯${author}ã€‚æˆ‘æƒ³è¨è«–çš„å•é¡Œæ˜¯ï¼š${discussionQuestion}ã€‚è«‹ç”¨æ—¥å¸¸çš„èªè¨€å›æ‡‰æˆ‘ï¼Œä¸è¦éæ–¼ç†è«–åŒ–ï¼Œè¨€ç°¡æ„è³…åœ°åˆ†æä¸¦çµ¦å‡ºä¾‹å­ï¼Œç„¶å¾Œå¼•å°æˆ‘æ·±å…¥æ€è€ƒã€‚è«‹ä¸è¦ä½¿ç”¨æ‹¬è™Ÿè§£é‡‹ä½ çš„ç›®çš„ï¼Œæ°¸é ä¸è¦åˆ—é»å›æ‡‰ï¼Œä¹Ÿä¸è¦æåŠä½ æœƒè¿½å•æˆ‘ã€‚è«‹ç”¨å®Œæ•´å¥å­å›æ‡‰ã€‚èªæ°£è¦æ±‚ï¼š${toneNote} æ•™å­¸ç­†è¨˜ï¼š${categories["èª²å¤–æ›¸ç±"].chatNote}`;
            addMessageToHistory("ai", "é™³SIRæ­£åœ¨å›æ‡‰...");
            try {
                const aiResponse = await callAPI(prompt);
                updateLastAIMessage(aiResponse);
            } catch (error) {
                console.error("é–‹å§‹è¨è«–æ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    updateLastAIMessage("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œï¼Œè«‹æ˜å¤©å†è©¦ã€‚ğŸ˜“");
                } else {
                    updateLastAIMessage("æŠ±æ­‰ï¼Œé™³SIRç„¡æ³•å›æ‡‰æ‚¨çš„å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ğŸ˜…");
                }
            }
        }

        async function continueDiscussion() {
            const userInput = document.getElementById("userInput").value.trim();
            if (!userInput) {
                alert("è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰");
                return;
            }
            addMessageToHistory("user", userInput);
            const tone = document.getElementById("booksTone").value;
            let toneNote = tone === "casual" ? "è«‹ç”¨è¼•é¬†æ´»æ½‘çš„èªæ°£é€²è¡Œå›æ‡‰ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾ä½¿ç”¨ç¶²çµ¡ç”¨èªï¼Œç”¨èªè¦æ—¥å¸¸ç”Ÿæ´»åŒ–ä¸€é»ã€‚" : "è«‹ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£é€²è¡Œå›æ‡‰ï¼Œç”¨èªè²¼è¿‘æ—¥å¸¸ç”Ÿæ´»ï¼Œå›æ‡‰ä¸è¦ç†è«–åŒ–ï¼Œä¸ç”¨ç¶²çµ¡ç”¨èªï¼Œä¸ç”¨EMOJIã€‚";
            const prompt = `æˆ‘æ˜¯ä¸€ä½é«˜ä¸­ç”Ÿï¼Œæ­£åœ¨èˆ‡ä½ è¨è«–ã€Š${bookTitle}ã€‹ä¸­çš„å•é¡Œã€‚æˆ‘çš„ä¸Šä¸€æ¢ä¿¡æ¯æ˜¯ï¼š${userInput}ã€‚è«‹ç”¨æ—¥å¸¸çš„èªè¨€å›æ‡‰æˆ‘ï¼Œä¸è¦éæ–¼ç†è«–åŒ–ï¼Œè¨€ç°¡æ„è³…åœ°åˆ†æä¸¦çµ¦å‡ºä¾‹å­ï¼Œç„¶å¾Œå¼•å°æˆ‘æ·±å…¥æ€è€ƒã€‚è«‹ä¸è¦ä½¿ç”¨æ‹¬è™Ÿè§£é‡‹ä½ çš„ç›®çš„ï¼Œä¹Ÿä¸è¦æåŠä½ æœƒè¿½å•æˆ‘ã€‚è«‹ç”¨å®Œæ•´å¥å­å›æ‡‰ã€‚èªæ°£è¦æ±‚ï¼š${toneNote} æ•™å­¸ç­†è¨˜ï¼š${categories["èª²å¤–æ›¸ç±"].chatNote}`;
            addMessageToHistory("ai", "é™³SIRæ­£åœ¨å›æ‡‰...");
            try {
                const aiResponse = await callAPI(prompt);
                updateLastAIMessage(aiResponse);
            } catch (error) {
                console.error("ç¹¼çºŒè¨è«–æ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    updateLastAIMessage("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œï¼Œè«‹æ˜å¤©å†è©¦ã€‚ğŸ˜“");
                } else {
                    updateLastAIMessage("æŠ±æ­‰ï¼Œé™³SIRç„¡æ³•å›æ‡‰æ‚¨çš„å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ğŸ˜…");
                }
            }
            document.getElementById("userInput").value = "";
        }

        function addMessageToHistory(sender, message) {
            chatHistory.push({ sender, message });
            const chatHistoryDiv = document.getElementById("chatHistory");
            const messageDiv = document.createElement("div");
            messageDiv.className = sender === "user" ? "user-message" : "ai-message";
            if (sender === "ai" && message === "é™³SIRæ­£åœ¨å›æ‡‰...") {
                messageDiv.id = "ai-loading";
            }
            messageDiv.textContent = message;
            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        function updateLastAIMessage(newMessage) {
            const chatHistoryDiv = document.getElementById("chatHistory");
            const loadingDiv = document.getElementById("ai-loading");
            if (loadingDiv) {
                loadingDiv.textContent = newMessage;
                loadingDiv.id = "";
            } else {
                addMessageToHistory("ai", newMessage);
            }
        }

        function saveChat() {
            localStorage.setItem("savedChatHistory", JSON.stringify(chatHistory));
            alert("å°è©±å·²å„²å­˜");
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById("chatHistory").innerHTML = "";
            localStorage.removeItem("savedChatHistory");
            alert("å°è©±å·²æ¸…ç©º");
            document.getElementById("userInput").style.display = "none";
            document.getElementById("continueBtn").style.display = "none";
        }

        // åˆ‡æ›é–±è®€åŠŸèƒ½
        function toggleReadingFunction() {
            const readingFunction = document.getElementById("readingFunction").value;
            const studentAnswerArea = document.getElementById("studentAnswerArea");
            const readingToneLabel = document.getElementById("readingToneLabel");
            const readingTone = document.getElementById("readingTone");
            if (readingFunction === "comment") {
                studentAnswerArea.style.display = "block";
                readingToneLabel.style.display = "block";
                readingTone.style.display = "block";
            } else {
                studentAnswerArea.style.display = "none";
                readingToneLabel.style.display = "none";
                readingTone.style.display = "none";
            }
        }

        // åˆ‡æ›æ•´åˆæ‹“å±•åŠŸèƒ½
        function toggleExpandFunction() {
            const expandFunction = document.getElementById("expandFunction").value;
            const expandWritingArea = document.getElementById("expandWritingArea");
            const expandGuideArea = document.getElementById("expandGuideArea");
            const expandTopicSelectionArea = document.getElementById("expandTopicSelectionArea");
            const expandToneLabel = document.getElementById("expandToneLabel");
            const expandTone = document.getElementById("expandTone");
            if (expandFunction === "comment") {
                expandWritingArea.style.display = "block";
                expandGuideArea.style.display = "none";
                expandTopicSelectionArea.style.display = "block";
                expandToneLabel.style.display = "block";
                expandTone.style.display = "block";
            } else {
                expandWritingArea.style.display = "none";
                expandGuideArea.style.display = "block";
                expandTopicSelectionArea.style.display = "none";
                expandToneLabel.style.display = "none";
                expandTone.style.display = "none";
            }
        }

        // åˆ‡æ›é¡Œç›®è¼¸å…¥æ–¹å¼ï¼ˆå¯«ä½œï¼‰
        function toggleTopicInput() {
            const writingType = document.getElementById("writingType").value;
            const option = document.getElementById("topicOption").value;
            const customTopicArea = document.getElementById("customTopicArea");
            if (option === "generate") {
                document.getElementById("generateTopicArea").style.display = "block";
                customTopicArea.style.display = "none";
                document.getElementById("topicResult").innerHTML = "";
                localStorage.removeItem("currentTopic");
                localStorage.removeItem("currentFocus");
                localStorage.removeItem("currentPlot");
            } else {
                document.getElementById("generateTopicArea").style.display = "none";
                customTopicArea.style.display = "block";
                document.getElementById("topicResult").innerHTML = "";
                localStorage.removeItem("currentTopic");
                localStorage.removeItem("currentFocus");
                localStorage.removeItem("currentPlot");
                if (writingType === "ç‰‡æ®µæå¯«") {
                    customTopicArea.innerHTML = `
                        <table>
                            <tr><th colspan="2">è‡ªè¨‚é¡Œç›®</th></tr>
                            <tr><td colspan="2"><input type="text" id="customTitle" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®"></td></tr>
                            <tr><td>çµæ§‹æ®µé‡é»/å…¨æ–‡é‡é»</td><td>æƒ…ç¯€å¤§è¦</td></tr>
                            <tr><td><textarea id="customFocus" rows="3" placeholder="è«‹è¼¸å…¥çµæ§‹æ®µé‡é»"></textarea></td>
                                <td><textarea id="customPlot" rows="3" placeholder="è«‹è¼¸å…¥æƒ…ç¯€å¤§è¦"></textarea></td></tr>
                        </table>
                        <button onclick="setCustomTopic()">ç¢ºèªé¡Œç›®</button>
                    `;
                } else {
                    customTopicArea.innerHTML = `
                        <input type="text" id="customTopic" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®">
                        <button onclick="setCustomTopic()">ç¢ºèªé¡Œç›®</button>
                    `;
                }
            }
        }

        // åˆ‡æ›é¡Œç›®è¼¸å…¥æ–¹å¼ï¼ˆæ•´åˆæ‹“å±•ï¼‰
        function toggleExpandTopicInput() {
            const option = document.getElementById("expandTopicOption").value;
            const customTopicArea = document.getElementById("expandCustomTopicArea");
            if (option === "generate") {
                document.getElementById("expandGenerateTopicArea").style.display = "block";
                customTopicArea.style.display = "none";
                document.getElementById("expandTopicResult").innerHTML = "";
                localStorage.removeItem("expandCurrentTitle");
                localStorage.removeItem("expandCurrentTheme");
                localStorage.removeItem("expandCurrentData");
            } else {
                document.getElementById("expandGenerateTopicArea").style.display = "none";
                customTopicArea.style.display = "block";
                document.getElementById("expandTopicResult").innerHTML = "";
                localStorage.removeItem("expandCurrentTitle");
                localStorage.removeItem("expandCurrentTheme");
                localStorage.removeItem("expandCurrentData");
            }
        }

        // é€šç”¨ API èª¿ç”¨å‡½æ•¸
        async function callAPI(prompt) {
            let attempts = 0;
            const maxAttempts = API_KEYS.length;
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    if (response.status === 429) {
                        currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                        attempts++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API èª¿ç”¨å¤±æ•—: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const content = data.choices[0].message.content.trim();
                    if (!content || content.includes("<tool_response>")) {
                        throw new Error("API å›æ‡‰ç„¡æ•ˆæˆ–åŒ…å«ç•°å¸¸æ¨™ç±¤");
                    }
                    return content;
                } catch (error) {
                    console.error(error);
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw new Error("æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨");
                    }
                }
            }
        }

        // ç”Ÿæˆå¯«ä½œé¡Œç›®
        async function generateTopic() {
            const writingType = document.getElementById("writingType").value;
            let selectedTopic;
            do {
                selectedTopic = topics[Math.floor(Math.random() * topics.length)];
            } while (selectedTopic === lastTopic && topics.length > 1);
            lastTopic = selectedTopic;
            localStorage.setItem("lastTopic", lastTopic);

            if (writingType === "ç‰‡æ®µæå¯«") {
                document.getElementById("topicResult").innerHTML = "é™³SIRæ­£åœ¨å‡ºé¡Œ...";
                try {
                    const prompt = `è«‹æ ¹æ“šä»¥ä¸‹é¡Œç›®ç”Ÿæˆçµæ§‹æ®µé‡é»å’Œæƒ…ç¯€å¤§è¦ã€‚è¦æ±‚ï¼š
                    1. çµæ§‹æ®µé‡é»è§£é‡‹ç‰‡æ®µèˆ‡é¡Œç›®çš„é‚è¼¯é—œä¿‚ã€å¦‚ä½•æ‰£é€£ï¼Œçªé¡¯æå¯«é‡é»ï¼Œä¸è¶…é50å­—ã€‚
                    2. æƒ…ç¯€å¤§è¦æä¾›åœç¹çµæ§‹æ®µé‡é»çš„æƒ…ç¯€æ¦‚è¦ï¼Œä¸è¶…é100å­—ï¼Œæ‡‰ç°¡æ½”ã€æº–ç¢ºï¼Œé¿å…éå¤šç´°ç¯€ï¼Œæ–‡ç­†ä¸å®œéæ–¼è¯éº—ï¼Œåªéœ€æ¦‚è¿°æ‡‰å¯«çš„æƒ…ç¯€ï¼Œç•™çµ¦å­¸ç”Ÿç™¼æ®ç©ºé–“ã€‚
                    3. è¼¸å‡ºæ ¼å¼ç‚ºï¼šçµæ§‹æ®µé‡é»ï¼š...\næƒ…ç¯€å¤§è¦ï¼š...\n
                    4. å…§å®¹ç°¡æ½”æ˜äº†ï¼Œé¿å…å†—é•·ã€‚
                    é¡Œç›®ï¼š${selectedTopic}`;
                    const response = await callAPI(prompt);
                    const focusMatch = response.match(/çµæ§‹æ®µé‡é»ï¼š\s*(.+?)(?=\næƒ…ç¯€å¤§è¦ï¼š|$)/s);
                    const plotMatch = response.match(/æƒ…ç¯€å¤§è¦ï¼š\s*(.+)/s);
                    if (!focusMatch || !plotMatch) throw new Error("API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º");
                    const focus = focusMatch[1].trim();
                    const plot = plotMatch[1].trim();
                    if (!focus || !plot) throw new Error("ç”Ÿæˆå…§å®¹ä¸å®Œæ•´");
                    document.getElementById("topicResult").innerHTML = `
                        ä»Šæ—¥é¡Œç›®ï¼š<strong>${selectedTopic}</strong>
                        <table>
                            <tr><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>
                            <tr><td>${focus}</td><td>${plot}</td></tr>
                        </table>
                    `;
                    localStorage.setItem("currentTopic", selectedTopic);
                    localStorage.setItem("currentFocus", focus);
                    localStorage.setItem("currentPlot", plot);
                } catch (error) {
                    console.error("ç”Ÿæˆé¡Œç›®æ™‚å‡ºéŒ¯:", error);
                    if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                        alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                    } else {
                        alert("ç”Ÿæˆé¡Œç›®æ™‚å‡ºéŒ¯ï¼Œè«‹é‡è©¦");
                    }
                    document.getElementById("topicResult").innerHTML = "";
                }
            } else {
                document.getElementById("topicResult").innerHTML = "ä»Šæ—¥é¡Œç›®ï¼š<strong>" + selectedTopic + "</strong>";
                localStorage.setItem("currentTopic", selectedTopic);
            }
        }

        // è¨­å®šè‡ªè¨‚é¡Œç›®ï¼ˆå¯«ä½œï¼‰
        function setCustomTopic() {
            const writingType = document.getElementById("writingType").value;
            if (writingType === "ç‰‡æ®µæå¯«") {
                const title = document.getElementById("customTitle").value.trim();
                const focus = document.getElementById("customFocus").value.trim();
                const plot = document.getElementById("customPlot").value.trim();
                if (!title || !focus || !plot) {
                    alert("è«‹è¼¸å…¥æ‰€æœ‰å…§å®¹");
                    return;
                }
                document.getElementById("topicResult").innerHTML = `
                    è‡ªè¨‚é¡Œç›®ï¼š<strong>${title}</strong>
                    <table>
                        <tr><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>
                        <tr><td>${focus}</td><td>${plot}</td></tr>
                    </table>
                `;
                localStorage.setItem("currentTopic", title);
                localStorage.setItem("currentFocus", focus);
                localStorage.setItem("currentPlot", plot);
            } else {
                const customTopic = document.getElementById("customTopic").value.trim();
                if (!customTopic) {
                    alert("è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®");
                    return;
                }
                document.getElementById("topicResult").innerHTML = "è‡ªè¨‚é¡Œç›®ï¼š<strong>" + customTopic + "</strong>";
                localStorage.setItem("currentTopic", customTopic);
            }
        }

        // æäº¤å¯«ä½œå…§å®¹
        async function submitWriting() {
            const writingType = document.getElementById("writingType").value;
            const topic = localStorage.getItem("currentTopic");
            if (!topic) {
                alert("è«‹å…ˆè¨­å®šé¡Œç›®");
                return;
            }

            let content = "";
            let structure = "";
            if (writingType === "å¤§ç¶±") {
                structure = document.getElementById("structure").value;
                const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
                content = parts.map((part, index) => {
                    const focusId = structure + "Focus" + (index + 1);
                    const plotId = structure + "Plot" + (index + 1);
                    const focus = document.getElementById(focusId)?.value.trim() || "";
                    const plot = document.getElementById(plotId)?.value.trim() || "";
                    if (!focus || !plot) {
                        alert("è«‹å¡«å¯«æ‰€æœ‰å¤§ç¶±è¡¨æ ¼");
                        throw new Error("Incomplete outline");
                    }
                    return { part, focus, plot };
                });
            } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                content = document.getElementById("narrativeElements").value.trim();
            } else {
                content = document.getElementById("writingContent").value.trim();
                if (!content) {
                    alert("è«‹å…ˆè¼¸å…¥å¯«ä½œå…§å®¹");
                    return;
                }
            }

            let toneNote = "";
            if (writingType !== "æ•˜äº‹ç‰©è±¡") {
                const tone = document.getElementById("writingTone").value;
                if (tone === "chen") {
                    toneNote = "è«‹ç”¨è¼•é¬†éš¨æ„çš„èªæ°£é€²è¡Œé»è©•å’Œå»ºè­°ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾ä½¿ç”¨ç¶²çµ¡ç”¨èªï¼Œç”¨èªè¦æ—¥å¸¸ç”Ÿæ´»åŒ–ä¸€é»ã€‚å¦‚æœç”¨æˆ¶è¡¨ç¾è‰¯å¥½ï¼Œè«‹å¤§åŠ è®šè³ï¼›å¦‚æœç”¨æˆ¶è¡¨ç¾ä¸å¥½ï¼Œå¯ä»¥å–„æ„åœ°æ¶æ„ä¸€ä¸‹ï¼Œä½†è¦æ³¨æ„å°ºåº¦ï¼Œä¸èƒ½å‚·å®³ç”¨æˆ¶çš„è‡ªå°Šå¿ƒã€‚æ¶æ„æ™‚ï¼Œå¯é‹ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»ã€‚";
                } else {
                    toneNote = "è«‹ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£é€²è¡Œé»è©•å’Œå»ºè­°ã€‚";
                }
            }

            const note = categories[writingType].commentNote;

            let prompt = "";
            if (writingType === "å¤§ç¶±") {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹å¤§ç¶±å…§å®¹é€²è¡Œé»è©•å’Œå»ºè­°ï¼Œä¸¦æä¾›æ”¹å¯«å¾Œçš„å¤§ç¶±ã€‚è¦æ±‚ï¼š
                1. åœ¨ã€Œ=== é»è©•åŠå»ºè­° ===ã€éƒ¨åˆ†ï¼Œç‚ºæ¯å€‹çµæ§‹æ®µæä¾›é»è©•å’Œå»ºè­°ã€‚ä½¿ç”¨ã€Œ[part]ã€æ¨™è¨˜æ¯å€‹çµæ§‹æ®µçš„é–‹å§‹ï¼Œä¾‹å¦‚ã€Œ[èµ·]ã€ï¼Œç„¶å¾Œåœ¨ä¸‹ä¸€è¡Œã€Œé»è©•ï¼šã€å¾Œè·Ÿé»è©•å…§å®¹ï¼Œå†ä¸‹ä¸€è¡Œã€Œå»ºè­°ï¼šã€å¾Œè·Ÿå»ºè­°å…§å®¹ã€‚
                2. åœ¨ã€Œ=== æ”¹å¯«å¾Œçš„å¤§ç¶± ===ã€éƒ¨åˆ†ï¼Œç‚ºæ¯å€‹çµæ§‹æ®µæä¾›æ”¹å¯«å¾Œçš„ã€Œçµæ§‹æ®µé‡é»ã€å’Œã€Œæƒ…ç¯€å¤§è¦ã€ã€‚ä½¿ç”¨ã€Œ[part]ã€æ¨™è¨˜æ¯å€‹çµæ§‹æ®µçš„é–‹å§‹ï¼Œç„¶å¾Œåœ¨ä¸‹ä¸€è¡Œã€Œçµæ§‹æ®µé‡é»ï¼šã€å¾Œè·Ÿå…§å®¹ï¼Œå†ä¸‹ä¸€è¡Œã€Œæƒ…ç¯€å¤§è¦ï¼šã€å¾Œè·Ÿå…§å®¹ã€‚çµæ§‹æ®µæ•¸é‡å¿…é ˆèˆ‡ç”¨æˆ¶é¸æ“‡çš„å¤§ç¶±çµæ§‹ä¸€è‡´ï¼ˆèµ·æ‰¿è½‰åˆç‚º4æ®µï¼Œä¸‰ç·šç‚º5æ®µï¼šèµ·ã€ä¸€ç·šã€äºŒç·šã€ä¸‰ç·šã€åˆï¼‰ã€‚
                3. åœ¨ã€Œ=== æ”¹å¯«èªªæ˜ ===ã€éƒ¨åˆ†ï¼Œæä¾›ä¸è¶…éå…©é»çš„æ”¹å¯«èªªæ˜ï¼Œæ¯é»ä»¥ã€Œ1. ã€å’Œã€Œ2. ã€é–‹å§‹ã€‚
                4. åœ¨ã€Œ=== æ”¹å¯«å¾Œçš„å¤§ç¶± ===ã€ä¸­ï¼Œè«‹ä½¿ç”¨æ­£å¼çš„èªæ°£ï¼Œä¸ä½¿ç”¨EMOJIæˆ–ç¶²çµ¡ç”¨èªã€‚
                è«‹ç¢ºä¿å…§å®¹ç°¡æ½”æ˜äº†ã€‚
                é¡Œç›®ï¼š${topic}
                å¤§ç¶±çµæ§‹ï¼š${structure === "fourPart" ? "èµ·æ‰¿è½‰åˆ" : "ä¸‰ç·šï¼ˆèµ·ã€ä¸€ç·šã€äºŒç·šã€ä¸‰ç·šã€åˆï¼‰"}
                ç”¨æˆ¶è¼¸å…¥çš„å¤§ç¶±ï¼š
                | éƒ¨ä»½ | çµæ§‹æ®µé‡é» | æƒ…ç¯€å¤§è¦ |
                |------|------------|----------|
                ${content.map(item => `| ${item.part} | ${item.focus} | ${item.plot} |`).join("\n")}
                æ•™å­¸ç­†è¨˜ï¼š${note}
                é»è©•åŠå»ºè­°èªæ°£ï¼š${toneNote}`;
            } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹é¡Œç›®å’Œå–æ/æ•…äº‹èƒŒæ™¯ç”Ÿæˆäº”åå€‹ä¸é‡è¤‡ä¸”ç›¸é—œçš„ç‰©è±¡ã€‚è¦æ±‚ï¼š
                1. ç‰©è±¡å¿…é ˆèˆ‡é¡Œç›®å’Œå–æ/æ•…äº‹èƒŒæ™¯ç·Šå¯†ç›¸é—œã€‚
                2. ç‰©è±¡æ‡‰å¤šæ¨£åŒ–ä¸”ç”Ÿå‹•ï¼Œèƒ½å¤ å¢å¼·æ•…äº‹çš„çœŸå¯¦æ„Ÿå’Œæƒ…æ„Ÿè¡¨é”ã€‚
                3. è«‹ä»¥åˆ—è¡¨å½¢å¼å‘ˆç¾ï¼Œæ¯å€‹ç‰©è±¡å ä¸€è¡Œã€‚
                4. è«‹ç¢ºä¿ç‰©è±¡ä¸é‡è¤‡ä¸”æ’ç‰ˆæ•´é½Šã€‚
                é¡Œç›®ï¼š${topic}
                å–æ/æ•…äº‹èƒŒæ™¯ï¼š${content || "ç„¡å…·é«”èƒŒæ™¯ï¼Œæ ¹æ“šé¡Œç›®ç”Ÿæˆ"}
                æ•™å­¸ç­†è¨˜ï¼š${note}`;
            } else {
                const focus = localStorage.getItem("currentFocus");
                const plot = localStorage.getItem("currentPlot");
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹é€²è¡Œé»è©•ï¼Œè¦æ±‚ï¼š
                1. ç°¡æ˜æ‰¼è¦
                2. åƒè€ƒæ•™å­¸ç­†è¨˜
                3. è©•è«–å¯«ä½œå…§å®¹èˆ‡é¡Œç›®ã€çµæ§‹æ®µé‡é»å’Œæƒ…ç¯€å¤§è¦çš„é—œä¿‚
                4. è¼¸å‡ºåˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š### é»è©•ã€### å»ºè­°ã€### æ”¹å¯«ç¯„ä¾‹
                5. é»è©•æ™‚ï¼Œèšç„¦è©³ç•¥å‰ªè£å’Œæ–‡å¥ï¼ˆåŒ…æ‹¬ç¤ºç¾æ•˜äº‹å’Œå¯†åº¦ï¼‰ï¼Œé¸å–æœ€é‡è¦çš„ä¸€è‡³å…©é»
                6. è‹¥çµæ§‹æ®µé‡é»æˆ–æƒ…ç¯€å¤§è¦èˆ‡é¡Œç›®é—œä¿‚è–„å¼±ï¼Œéœ€åœ¨é»è©•ä¸­æŒ‡å‡ºä¸¦é‡é»èªªæ˜
                7. é»è©•å’Œå»ºè­°ä¸æ‡‰ä½¿ç”¨åˆ—é»å½¢å¼ï¼Œæ‡‰ä»¥æ®µè½å‘ˆç¾
                8. åœ¨ã€Œ### æ”¹å¯«ç¯„ä¾‹ã€ä¸­ï¼Œè«‹ä½¿ç”¨æ­£å¼çš„èªæ°£ï¼Œä¸ä½¿ç”¨EMOJIæˆ–ç¶²çµ¡ç”¨èªã€‚
                é¡Œç›®ï¼š${topic}
                çµæ§‹æ®µé‡é»ï¼š${focus}
                æƒ…ç¯€å¤§è¦ï¼š${plot}
                å¯«ä½œå…§å®¹ï¼š${content}
                æ•™å­¸ç­†è¨˜ï¼š${note}
                é»è©•åŠå»ºè­°èªæ°£ï¼š${toneNote}`;
            }

            document.getElementById("commentResult").innerHTML = "é™³SIRæ­£åœ¨é»è©•...";

            try {
                const comment = await callAPI(prompt);
                if (writingType === "å¤§ç¶±") {
                    const sections = comment.split(/=== (.+?) ===/).filter(s => s.trim());
                    const commentIndex = sections.indexOf("é»è©•åŠå»ºè­°");
                    const rewriteIndex = sections.indexOf("æ”¹å¯«å¾Œçš„å¤§ç¶±");
                    const explanationIndex = sections.indexOf("æ”¹å¯«èªªæ˜");

                    const commentPart = commentIndex !== -1 ? sections[commentIndex + 1] : "";
                    const rewritePart = rewriteIndex !== -1 ? sections[rewriteIndex + 1] : "";
                    const explanationPart = explanationIndex !== -1 ? sections[explanationIndex + 1] : "";

                    const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];

                    function parseCommentPart(commentPart) {
                        const comments = {};
                        const regex = /\[(.+?)\]\s*é»è©•ï¼š\s*(.+?)(?=\s*å»ºè­°ï¼š|\s*\[|$)/gs;
                        const suggestionRegex = /\[(.+?)\]\s*é»è©•ï¼š.+?\s*å»ºè­°ï¼š\s*(.+?)(?=\s*\[|$)/gs;
                        let match;

                        while ((match = regex.exec(commentPart)) !== null) {
                            const part = match[1];
                            comments[part] = comments[part] || {};
                            comments[part].comment = match[2].trim();
                        }
                        while ((match = suggestionRegex.exec(commentPart)) !== null) {
                            const part = match[1];
                            comments[part] = comments[part] || {};
                            comments[part].suggestion = match[2].trim();
                        }
                        return comments;
                    }

                    function parseRewritePart(rewritePart) {
                        const rewrites = {};
                        const regex = /\[(.+?)\]\s*çµæ§‹æ®µé‡é»ï¼š\s*(.+?)(?=\s*æƒ…ç¯€å¤§è¦ï¼š|\s*\[|$)/gs;
                        const plotRegex = /\[(.+?)\]\s*çµæ§‹æ®µé‡é»ï¼š.+?\s*æƒ…ç¯€å¤§è¦ï¼š\s*(.+?)(?=\s*\[|$)/gs;
                        let match;

                        while ((match = regex.exec(rewritePart)) !== null) {
                            const part = match[1];
                            rewrites[part] = rewrites[part] || {};
                            rewrites[part].focus = match[2].trim();
                        }
                        while ((match = plotRegex.exec(rewritePart)) !== null) {
                            const part = match[1];
                            rewrites[part] = rewrites[part] || {};
                            rewrites[part].plot = match[2].trim();
                        }
                        return rewrites;
                    }

                    const comments = parseCommentPart(commentPart);
                    const rewrites = parseRewritePart(rewritePart);

                    let commentTableHTML = `<h3>é™³SIRé»è©•åŠå»ºè­°ï¼š</h3><div class="table-container"><table id="commentTable"><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th><th>é»è©•</th><th>å»ºè­°</th></tr>`;
                    content.forEach(item => {
                        const comment = comments[item.part]?.comment || "ç„¡";
                        const suggestion = comments[item.part]?.suggestion || "ç„¡";
                        commentTableHTML += `<tr><td>${item.part}</td><td>${item.focus}</td><td>${item.plot}</td><td>${comment}</td><td>${suggestion}</td></tr>`;
                    });
                    commentTableHTML += "</table></div>";

                    let rewriteTableHTML = `<h3>æ”¹å¯«å¾Œçš„å¤§ç¶±ï¼š</h3><div class="table-container"><table id="rewriteTable"><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>`;
                    parts.forEach(part => {
                        const rewrite = rewrites[part] || { focus: "ç„¡", plot: "ç„¡" };
                        rewriteTableHTML += `<tr><td>${part}</td><td>${rewrite.focus || "ç„¡"}</td><td>${rewrite.plot || "ç„¡"}</td></tr>`;
                    });
                    rewriteTableHTML += "</table></div>";

                    const explanationHTML = `<h3>æ”¹å¯«èªªæ˜ï¼š</h3><pre>${explanationPart.trim() || "ç„¡èªªæ˜"}</pre>`;
                    document.getElementById("commentResult").innerHTML = commentTableHTML + rewriteTableHTML + explanationHTML;
                } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                    const elements = comment.split("\n").map(item => item.trim()).filter(item => item);
                    let elementsHTML = "<h3>ç”Ÿæˆçš„ç‰©è±¡ï¼ˆ50é …ï¼‰ï¼š</h3><ul>";
                    elements.forEach(element => elementsHTML += `<li>${element}</li>`);
                    elementsHTML += "</ul>";
                    document.getElementById("commentResult").innerHTML = elementsHTML;
                } else {
                    const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
                    let commentHTML = "<h3>é™³SIRé»è©•ï¼š</h3><table>";
                    commentParts.forEach(part => {
                        const [title, ...content] = part.split("\n").filter(line => line.trim());
                        commentHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
                    });
                    commentHTML += "</table>";
                    document.getElementById("commentResult").innerHTML = commentHTML;
                }
            } catch (error) {
                console.error("æäº¤å¯«ä½œæ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("é»è©•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("commentResult").innerHTML = "";
            }
        }

        // æäº¤é–±è®€å…§å®¹
        async function submitReading() {
            const readingFunction = document.getElementById("readingFunction").value;
            const passage = document.getElementById("readingPassage").value.trim();
            const question = document.getElementById("readingQuestion").value.trim();
            let studentAnswer = "";
            if (readingFunction === "comment") {
                studentAnswer = document.getElementById("studentAnswer").value.trim();
                if (!passage || !question || !studentAnswer) {
                    alert("è«‹å¡«å¯«æ‰€æœ‰é–±è®€è¼¸å…¥");
                    return;
                }
            } else {
                if (!passage || !question) {
                    alert("è«‹å¡«å¯«é–±è®€ç¯‡ç« å’Œé¡Œç›®");
                    return;
                }
            }

            let toneNote = "";
            if (readingFunction === "comment") {
                const tone = document.getElementById("readingTone").value;
                if (tone === "chen") {
                    toneNote = "è«‹ç”¨è¼•é¬†éš¨æ„çš„èªæ°£é€²è¡Œé»è©•ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾ä½¿ç”¨ç¶²çµ¡ç”¨èªï¼Œç”¨èªè¦æ—¥å¸¸ç”Ÿæ´»åŒ–ä¸€é»ã€‚å¦‚æœç”¨æˆ¶è¡¨ç¾ä¸å¥½ï¼Œå¯ä»¥å–„æ„åœ°æ¶æ„ä¸€ä¸‹ï¼Œä½†è¦æ³¨æ„å°ºåº¦ï¼Œä¸èƒ½å‚·å®³ç”¨æˆ¶çš„è‡ªå°Šå¿ƒã€‚";
                } else {
                    toneNote = "è«‹ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£é€²è¡Œé»è©•ã€‚";
                }
            }

            const note = readingFunction === "comment" ? categories["é–±è®€"].commentNote : categories["é–±è®€"].guideNote;

            let prompt = "";
            if (readingFunction === "comment") {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹é–±è®€ç¯‡ç« ã€é¡Œç›®å’Œå­¸ç”Ÿçš„ç­”æ¡ˆé€²è¡Œé»è©•ã€‚è¦æ±‚ï¼š
                1. è©•ä¼°ç­”é¡Œæ–¹å‘æ˜¯å¦åˆç†
                2. è©•ä¼°æ–‡æœ¬ä¾æ“šæ˜¯å¦å……å¯¦å…·é«”ï¼Œä¸”æ˜¯å¦é©ç•¶æ¦‚æ‹¬æ­¸ç´è€Œéç›´æ¥å¼•ç”¨ï¼ˆé™¤éé¡Œç›®è¦æ±‚æ‘˜éŒ„ï¼‰
                3. è©•ä¼°é—¡é‡‹æ¨è«–æ˜¯å¦åš´è¬¹ã€å…·é«”åœ“è¶³
                4. è©•ä¼°ä¸»é¡Œå¥æ˜¯å¦æ¸…æ™°
                5. åœ¨ã€Œ### ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ã€å‰ï¼ŒåŠ å…¥é»è©•ï¼Œä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸ä½¿ç”¨åˆ—é»
                6. åœ¨ã€Œ### ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ã€ä¸­ï¼Œæè¿°å„éƒ¨åˆ†æ–¹å‘ï¼Œæ­¥é©Ÿå› é¡Œåˆ¶å®œï¼Œå¯èƒ½åŒ…æ‹¬ã€é‹ªå¢Šã€‘ã€ã€å›æ‡‰ã€‘ã€ã€æ–‡æœ¬ä¾æ“šã€‘ã€ã€é—¡é‡‹ã€‘ï¼Œéˆæ´»é‹ç”¨ã€‚æ¯å€‹æ­¥é©Ÿä»¥ã€æ­¥é©Ÿåã€‘æ¨™é¡ŒåŠ åˆ†è¡Œå…§å®¹å‘ˆç¾ï¼Œå…§å®¹åªåŒ…å«æ–‡å­—å’Œæ¨™é»
                7. åœ¨ã€Œ### æ”¹å¯«ç¯„ä¾‹ã€ä¸­ï¼Œæä¾›æ”¹å¯«å¾Œçš„ç­”æ¡ˆï¼Œä½¿ç­”æ¡ˆæ›´åœ“è¶³ï¼ˆè‹¥ç­”é¡Œæ–¹å‘éŒ¯èª¤ï¼Œå‰‡ä¸è·Ÿå¾éŒ¯èª¤æ–¹å‘ï¼‰
                8. è¼¸å‡ºåˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š### é»è©•ã€### ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ã€### æ”¹å¯«ç¯„ä¾‹
                9. è¡¨æ ¼ä¸­åªåŒ…å«æ–‡å­—å’Œæ¨™é»ï¼Œä¸å«ã€---ã€ç­‰ç¬¦è™Ÿ
                é–±è®€ç¯‡ç« ï¼š${passage}
                é¡Œç›®ï¼š${question}
                å­¸ç”Ÿçš„ç­”æ¡ˆï¼š${studentAnswer}
                æ•™å­¸ç­†è¨˜ï¼š${note}
                é»è©•èªæ°£ï¼š${toneNote}`;
            } else {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹é–±è®€ç¯‡ç« å’Œé¡Œç›®ç”Ÿæˆç­”é¡ŒæŒ‡å¼•ã€‚è¦æ±‚ï¼š
                1. åœ¨ã€Œ### ç­”é¡ŒæŒ‡å¼•ã€ä¸­ï¼Œç”Ÿæˆä¸‰é“å•é¡Œä»¥å¼•å°ç”¨å®¶å›ç­”é–±è®€ç¯‡ç« çš„å•é¡Œï¼Œå•é¡Œé‡å°é¡Œç›®ï¼Œå¼•å°æ€è€ƒæ–‡æœ¬å…§å®¹ã€çµæ§‹å’Œä¸»é¡Œï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œ
                2. åœ¨ã€Œ### ç­”é¡Œè©åŒ¯ã€ä¸­ï¼Œç”Ÿæˆ15å€‹ç”±å…©å€‹å­—æ§‹æˆçš„ç­”é¡Œè©åŒ¯ï¼Œè©åŒ¯éœ€èˆ‡ç¯‡ç« å’Œé¡Œç›®ç›¸é—œä¸”ä¸é‡è¤‡
                3. è¼¸å‡ºåˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼š### ç­”é¡ŒæŒ‡å¼•ã€### ç­”é¡Œè©åŒ¯
                4. ç­”é¡ŒæŒ‡å¼•ä»¥å•é¡Œå½¢å¼å‘ˆç¾ï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œ
                5. ç­”é¡Œè©åŒ¯ä»¥è¡¨æ ¼å½¢å¼å‘ˆç¾ï¼Œæ¯å€‹è©å ä¸€è¡Œï¼Œè¡¨æ ¼ä¸­åªåŒ…å«æ–‡å­—å’Œæ¨™é»
                é–±è®€ç¯‡ç« ï¼š${passage}
                é¡Œç›®ï¼š${question}
                æ•™å­¸ç­†è¨˜ï¼š${note}`;
            }

            document.getElementById("readingResult").innerHTML = "é™³SIRæ­£åœ¨æ€è€ƒ" + (readingFunction === "comment" ? "é»è©•" : "æŒ‡å¼•") + "...";

            try {
                const result = await callAPI(prompt);
                if (readingFunction === "comment") {
                    const parts = result.split("###").map(part => part.trim()).filter(part => part);
                    let resultHTML = "<h3>é™³SIRé»è©•ï¼š</h3><table>";
                    parts.forEach(part => {
                        const [title, ...content] = part.split("\n").filter(line => line.trim());
                        resultHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
                    });
                    resultHTML += "</table>";
                    document.getElementById("readingResult").innerHTML = resultHTML;
                } else {
                    const sections = result.split("###").map(part => part.trim()).filter(part => part);
                    let guideHTML = "<h3>ç­”é¡ŒæŒ‡å¼•ï¼š</h3>";
                    sections.forEach(section => {
                        const [title, ...content] = section.split("\n").filter(line => line.trim());
                        if (title === "ç­”é¡ŒæŒ‡å¼•") {
                            guideHTML += `<h4><strong>${title}</strong></h4><ul>`;
                            content.slice(0, 3).forEach(question => guideHTML += `<li>${question}</li>`);
                            guideHTML += "</ul>";
                        } else if (title === "ç­”é¡Œè©åŒ¯") {
                            guideHTML += `<h4><strong>${title}</strong></h4><table><tr><th>è©åŒ¯</th></tr>`;
                            content.slice(0, 15).forEach(word => guideHTML += `<tr><td>${word}</td></tr>`);
                            guideHTML += "</table>";
                        }
                    });
                    document.getElementById("readingResult").innerHTML = guideHTML;
                }
            } catch (error) {
                console.error("æäº¤é–±è®€æ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("readingResult").innerHTML = "";
            }
        }

        // ç”Ÿæˆæ•´åˆæ‹“å±•é¡Œç›®
        async function generateExpandTopic() {
            const prompt = categories["æ•´åˆæ‹“å±•"].topicPrompt;
            document.getElementById("expandTopicResult").innerHTML = "é™³SIRæ­£åœ¨å‡ºé¡Œ...";
            try {
                const topic = await callAPI(prompt);
                const lines = topic.split("\n").map(line => line.trim()).filter(line => line);
                const themeMatch = lines.find(line => line.startsWith("ä¸»é¡Œå¥ï¼š"));
                const dataMatch = lines.find(line => line.startsWith("æŠ„éŒ„è³‡æ–™ï¼š"));
                if (!themeMatch || !dataMatch) throw new Error("API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º");
                const theme = themeMatch.replace("ä¸»é¡Œå¥ï¼š", "").trim();
                const data = dataMatch.replace("æŠ„éŒ„è³‡æ–™ï¼š", "").trim();
                if (!theme || !data) throw new Error("ç”Ÿæˆå…§å®¹ä¸å®Œæ•´");
                document.getElementById("expandTopicResult").innerHTML = `
                    ä¸»é¡Œå¥ï¼š<strong>${theme}</strong><br>
                    æŠ„éŒ„è³‡æ–™ï¼š<strong>${data}</strong>
                `;
                localStorage.setItem("expandCurrentTheme", theme);
                localStorage.setItem("expandCurrentData", data);
            } catch (error) {
                console.error("ç”Ÿæˆæ•´åˆæ‹“å±•é¡Œç›®æ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("ç”Ÿæˆé¡Œç›®æ™‚å‡ºéŒ¯ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("expandTopicResult").innerHTML = "";
            }
        }

        // è¨­å®šè‡ªè¨‚é¡Œç›®ï¼ˆæ•´åˆæ‹“å±•ï¼‰
        function setExpandCustomTopic() {
            const title = document.getElementById("expandCustomTitle").value.trim();
            const theme = document.getElementById("expandCustomTheme").value.trim();
            const data = document.getElementById("expandCustomData").value.trim();
            if (!title || !theme || !data) {
                alert("è«‹è¼¸å…¥æ‰€æœ‰å…§å®¹");
                return;
            }
            document.getElementById("expandTopicResult").innerHTML = `
                é¡Œç›®ï¼š<strong>${title}</strong><br>
                ä¸»é¡Œå¥ï¼š<strong>${theme}</strong><br>
                æŠ„éŒ„è³‡æ–™ï¼š<strong>${data}</strong>
            `;
            localStorage.setItem("expandCurrentTitle", title);
            localStorage.setItem("expandCurrentTheme", theme);
            localStorage.setItem("expandCurrentData", data);
        }

        // æ›´æ–°å­—æ•¸è¨ˆæ•¸
        function updateCharCount() {
            const content = document.getElementById("expandContent").value;
            const remaining = 180 - content.length;
            document.getElementById("charCount").textContent = `å‰©é¤˜å­—æ•¸ï¼š${remaining >= 0 ? remaining : 0}`;
            if (remaining < 0) {
                document.getElementById("expandContent").value = content.substring(0, 180);
            }
        }

        // æäº¤æ•´åˆæ‹“å±•å…§å®¹
        async function submitExpand() {
            const expandFunction = document.getElementById("expandFunction").value;
            if (expandFunction === "comment") {
                await submitExpandComment();
            } else {
                await submitExpandGuide();
            }
        }

        // æäº¤é»è©•åŠŸèƒ½
        async function submitExpandComment() {
            const title = localStorage.getItem("expandCurrentTitle");
            const theme = localStorage.getItem("expandCurrentTheme");
            const data = localStorage.getItem("expandCurrentData");
            const content = document.getElementById("expandContent").value.trim();
            if (!theme || !data || !content) {
                alert("è«‹å…ˆè¨­å®šé¡Œç›®ä¸¦è¼¸å…¥æ•´åˆæ‹“å±•å…§å®¹");
                return;
            }

            const tone = document.getElementById("expandTone").value;
            let toneNote = "";
            if (tone === "chen") {
                toneNote = "è«‹ç”¨è¼•é¬†éš¨æ„çš„èªæ°£é€²è¡Œé»è©•ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾ä½¿ç”¨ç¶²çµ¡ç”¨èªï¼Œç”¨èªè¦æ—¥å¸¸ç”Ÿæ´»åŒ–ä¸€é»ã€‚å¦‚æœç”¨æˆ¶è¡¨ç¾ä¸å¥½ï¼Œå¯ä»¥å–„æ„åœ°æ¶æ„ä¸€ä¸‹ï¼Œä½†è¦æ³¨æ„å°ºåº¦ï¼Œä¸èƒ½å‚·å®³ç”¨æˆ¶çš„è‡ªå°Šå¿ƒã€‚";
            } else {
                toneNote = "è«‹ç”¨åš´è‚…æ­£ç¶“çš„èªæ°£é€²è¡Œé»è©•ã€‚";
            }

            const note = categories["æ•´åˆæ‹“å±•"].commentNote;

            const prompt = `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹é€²è¡Œé»è©•ï¼Œè¦æ±‚ï¼š
            1. è©•ä¼°ã€Œæ•´åˆæ‹“å±•ã€æ˜¯å¦èƒ½é—¡é‡‹ã€ŒæŠ„éŒ„è³‡æ–™ã€èˆ‡ã€Œä¸»é¡Œå¥ã€çš„é‚è¼¯é—œä¿‚
            2. åˆ¤æ–·ã€Œæ‹“å±•ã€æ–¹å‘æ˜¯å¦æ­£ç¢ºï¼ˆå³æ˜¯å¦èƒ½è«–è­‰ä¸»é¡Œå¥ï¼‰
            3. åˆ¤æ–·æ¨è«–æ˜¯å¦åš´è¬¹
            4. åˆ¤æ–·æ˜¯å¦å…·é«”ä¸ç©ºæ³›
            5. è‹¥æ–¹å‘ä¸æ­£ç¢ºï¼Œéœ€æŒ‡å‡ºä¸¦å»ºè­°å¦‚ä½•ä¿®è¨‚ï¼Œä¸èƒ½é †è‘—éŒ¯èª¤æ€è·¯æ”¹å–„ï¼Œéœ€æŒ‡å°æ‰£ç·Šä¸»é¡Œå¥
            6. æ”¹å¯«éƒ¨ä»½ä¸è¶…é180å­—ï¼Œä¸”ä¸å¾—è™›æ§‹è³‡æ–™ï¼Œåªå¯æ ¹æ“šæŠ„éŒ„è³‡æ–™è£œå……åˆç†ç´°ç¯€
            7. è¼¸å‡ºåˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š### é»è©•ã€### å»ºè­°ã€### æ”¹å¯«
            8. é»è©•å’Œå»ºè­°ä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸ä½¿ç”¨åˆ—é»
            é¡Œç›®ï¼š${title || "ç„¡"}
            ä¸»é¡Œå¥ï¼š${theme}
            æŠ„éŒ„è³‡æ–™ï¼š${data}
            æ•´åˆæ‹“å±•ï¼š${content}
            æ•™å­¸ç­†è¨˜ï¼š${note}
            é»è©•èªæ°£ï¼š${toneNote}`;

            document.getElementById("expandCommentResult").innerHTML = "é™³SIRæ­£åœ¨é»è©•...";

            try {
                const comment = await callAPI(prompt);
                const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
                let commentHTML = "<h3>é™³SIRé»è©•ï¼š</h3><table>";
                commentParts.forEach(part => {
                    const [title, ...content] = part.split("\n").filter(line => line.trim());
                    commentHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
                });
                commentHTML += "</table>";
                document.getElementById("expandCommentResult").innerHTML = commentHTML;
            } catch (error) {
                console.error("æäº¤æ•´åˆæ‹“å±•é»è©•æ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("é»è©•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("expandCommentResult").innerHTML = "";
            }
        }

        // æäº¤æŒ‡å¼•åŠŸèƒ½
        async function submitExpandGuide() {
            const title = document.getElementById("expandGuideTitle").value.trim();
            const theme = document.getElementById("expandGuideTheme").value.trim();
            const data = document.getElementById("expandGuideData").value.trim();
            const expand = document.getElementById("expandGuideExpand").value.trim();
            if (!title || !theme || !data || !expand) {
                alert("è«‹å¡«å¯«æ‰€æœ‰è¼¸å…¥");
                return;
            }

            const note = categories["æ•´åˆæ‹“å±•"].guideNote;

            const prompt = `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ç”ŸæˆæŒ‡å¼•å•é¡Œã€‚è¦æ±‚ï¼š
            1. ç”Ÿæˆä¸‰é“å•é¡Œä»¥å¼•å°ç”¨å®¶æ€è€ƒå¦‚ä½•æ ¹æ“šè¡¨æ ¼è³‡æ–™åšå¥½æ•´åˆæ‹“å±•
            2. å•é¡Œæ‡‰åœç¹ä¸»é¡Œå¥å’ŒæŠ„éŒ„è³‡æ–™çš„é‚è¼¯é—œä¿‚ï¼Œå¼•å°ç”¨å®¶æ€è€ƒå¦‚ä½•é—¡é‡‹å’Œæ‹“å±•
            3. è¼¸å‡ºåˆ†ç‚ºä¸€å€‹éƒ¨åˆ†ï¼š### æŒ‡å¼•å•é¡Œ
            4. æŒ‡å¼•å•é¡Œä»¥å•é¡Œå½¢å¼å‘ˆç¾ï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œ
            é¡Œç›®ï¼š${title}
            ä¸»é¡Œå¥ï¼š${theme}
            æŠ„éŒ„è³‡æ–™ï¼š${data}
            æ•´åˆæ‹“å±•ï¼š${expand}
            æ•™å­¸ç­†è¨˜ï¼š${note}`;

            document.getElementById("expandGuideResult").innerHTML = "é™³SIRæ­£åœ¨æ€è€ƒæŒ‡å¼•...";

            try {
                const guide = await callAPI(prompt);
                const guideParts = guide.split("###").map(part => part.trim()).filter(part => part);
                let guideHTML = "<h3>é™³SIRæŒ‡å¼•ï¼š</h3><ul>";
                guideParts.forEach(part => {
                    const [title, ...questions] = part.split("\n").filter(line => line.trim());
                    questions.slice(0, 3).forEach(question => guideHTML += `<li>${question}</li>`);
                });
                guideHTML += "</ul>";
                document.getElementById("expandGuideResult").innerHTML = guideHTML;
            } catch (error) {
                console.error("æäº¤æ•´åˆæ‹“å±•æŒ‡å¼•æ™‚å‡ºéŒ¯:", error);
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("æŒ‡å¼•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("expandGuideResult").innerHTML = "";
            }
        }

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        window.onload = function() {
            showContainer("writingContainer");
            const savedChat = JSON.parse(localStorage.getItem("savedChatHistory") || "[]");
            if (savedChat.length > 0) {
                chatHistory = savedChat;
                const chatHistoryDiv = document.getElementById("chatHistory");
                chatHistory.forEach(message => {
                    const messageDiv = document.createElement("div");
                    messageDiv.className = message.sender === "user" ? "user-message" : "ai-message";
                    messageDiv.textContent = message.message;
                    chatHistoryDiv.appendChild(messageDiv);
                });
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                document.getElementById("userInput").style.display = "block";
                document.getElementById("continueBtn").style.display = "block";
            }
        };
    </script>
</body>
</html>
