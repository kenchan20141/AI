<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中文老師的救星</title>
    <style>
        /* 原有樣式保持不變 */
    </style>
</head>
<body>
    <!-- 其他部分保持不變 -->

    <!-- 整合拓展容器 -->
    <div id="expandContainer" class="box">
        <h2>整合拓展</h2>
        <label for="expandFunction">選擇功能：</label>
        <select id="expandFunction" onchange="toggleExpandFunction()">
            <option value="comment">點評</option>
            <option value="guide">指引</option>
        </select>
        <div id="expandTopicSelectionArea">
            <label for="expandTopicOption">選擇題目方式：</label>
            <select id="expandTopicOption" onchange="toggleExpandTopicInput()">
                <option value="generate">生成題目</option>
                <option value="custom">自訂題目</option>
            </select>
            <div id="expandGenerateTopicArea">
                <button onclick="generateExpandTopic()">生成題目</button>
            </div>
            <div id="expandCustomTopicArea" style="display: none;">
                <table>
                    <tr><th>題目</th><td><input type="text" id="expandCustomTitle" placeholder="請輸入題目"></td></tr>
                    <tr><th>主題句</th><td><textarea id="expandCustomTheme" rows="2" placeholder="請輸入主題句"></textarea></td></tr>
                    <tr><th>抄錄資料</th><td><textarea id="expandCustomData" rows="3" placeholder="請輸入抄錄資料"></textarea></td></tr>
                </table>
                <button onclick="setExpandCustomTopic()">確認題目</button>
            </div>
            <div id="expandTopicResult"></div>
        </div>
        <div id="expandInputArea">
            <div id="expandCommentInput" style="display: block;">
                <label for="expandContent">整合拓展（最多180字）：</label>
                <textarea id="expandContent" rows="5" placeholder="請在此輸入整合拓展內容..." oninput="updateCharCount()"></textarea>
                <p id="charCount">剩餘字數：180</p>
            </div>
            <div id="expandGuideInput" style="display: none;">
                <!-- 指引功能無需額外輸入 -->
            </div>
            <button onclick="submitExpand()">提交</button>
            <div id="expandResult"></div>
        </div>
    </div>

    <script>
        // API 配置信息（保持不變）
        const API_KEYS = [
            "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",
            "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",
            "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"
        ];
        let currentApiKeyIndex = 0;
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const MODEL = "deepseek/deepseek-r1:free";

        // 範疇定義（僅展示「整合拓展」部分）
        const categories = {
            "整合拓展": {
                topicPrompt: "請生成一道適合中學生練習整合拓展的題目，題目應包含主題句和抄錄資料。要求：1. 主題句簡潔，20字以內。2. 抄錄資料為一段文字，不超過100字。3. 輸出格式為：主題句：...\n抄錄資料：...\n4. 內容簡潔明了，避免冗長。5. 題目多樣化，避免重複。",
                commentNote: "必須用繁體字。點評時，需評估「整合拓展」是否能闡釋「抄錄資料」與「主題句」的邏輯關係。需判斷：1.「拓展」方向是否正確（即是否能論證主題句）；2.推論是否嚴謹；3.是否具體不空泛。「點評」時，若方向不正確，需指出並建議如何修訂，需指導緊扣主題句，亦須分析主題句和題目任務的關係是否緊密，例如題目任務為提出建議，但主題句焦點卻是描述問題，則屬於不妥當。「改寫」時亦不能順著「整合拓展」錯誤思路改善，需扣緊主題句，假如主題句本身就未能緊扣題目的任務，則不應圍繞本身錯誤的主題句改寫，要在「改寫」部份針對一個正確的主題句作改寫。此外，改寫部份不宜分為太多角度論述，這樣會令闡釋較零散，須就最多2個角度深入分析、闡釋。改寫部份不得超過180字，且不得虛構資料，包括數據及調查，不要自擬「根據調查」之類，只可根據抄錄資料補充合理細節，「改寫」部份不要重複用家輸入的「抄錄資料」，會白白浪費空間。此外，「改寫」亦要嚴謹對應主題句及抄錄資料關係，例如主題句描述活動問題，則在「改寫」的部份不宜聚焦在改善措施，必須注意詳略、輕重，才能突顯主題句。此外，「改寫」亦要留意題目任務，不要在「改寫」時會順著用家詳略不當或錯誤的「整合拓展」思路改寫。此外，「改寫」部份不要太數據化，例如做計算及分析數據等，這部份最重要是交代事理的邏輯關係。點評分為三部分：### 點評、### 建議、### 改寫。點評和建議以段落形式呈現，不使用列點。拓展方法：以抄錄資料為起點，主題句為終點，運用橫向拓展（逐步推論，回答「為何」或「如何」）或直向拓展（補充具體例子或細節）。改寫部份必須注意要運用好橫向拓展及直向拓展的技巧。常見問題包括：推論方向錯誤、未推論到底、推論點重複、推論跳脫、有量無質，需針對性指出，改寫時亦要避免犯下這些問題。",
                guideNote: "必須用繁體字。請根據題目、主題句和抄錄資料，生成三個問題，引導學生思考如何進行整合拓展。問題應幫助學生分析抄錄資料與主題句的關係，並思考如何展開論述。請僅生成三個問題，每個問題占一行，不要包含其他內容。"
            }
        };

        // 範疇切換（保持不變）
        document.getElementById("expandBtn").addEventListener("click", function() {
            showContainer("expandContainer");
        });

        function showContainer(containerId) {
            document.getElementById("writingContainer").style.display = "none";
            document.getElementById("readingContainer").style.display = "none";
            document.getElementById("booksContainer").style.display = "none";
            document.getElementById("expandContainer").style.display = "none";
            document.getElementById(containerId).style.display = "block";
            if (containerId === "expandContainer") toggleExpandFunction();
        }

        // 整合拓展功能切換
        function toggleExpandFunction() {
            const expandFunction = document.getElementById("expandFunction").value;
            const commentInput = document.getElementById("expandCommentInput");
            const guideInput = document.getElementById("expandGuideInput");

            if (expandFunction === "comment") {
                commentInput.style.display = "block";
                guideInput.style.display = "none";
            } else {
                commentInput.style.display = "none";
                guideInput.style.display = "block";
            }
        }

        // 切換題目輸入方式（整合拓展）
        function toggleExpandTopicInput() {
            const option = document.getElementById("expandTopicOption").value;
            const customTopicArea = document.getElementById("expandCustomTopicArea");
            if (option === "generate") {
                document.getElementById("expandGenerateTopicArea").style.display = "block";
                customTopicArea.style.display = "none";
                document.getElementById("expandTopicResult").innerHTML = "";
                localStorage.removeItem("expandCurrentTitle");
                localStorage.removeItem("expandCurrentTheme");
                localStorage.removeItem("expandCurrentData");
            } else {
                document.getElementById("expandGenerateTopicArea").style.display = "none";
                customTopicArea.style.display = "block";
                document.getElementById("expandTopicResult").innerHTML = "";
                localStorage.removeItem("expandCurrentTitle");
                localStorage.removeItem("expandCurrentTheme");
                localStorage.removeItem("expandCurrentData");
            }
        }

        // 生成整合拓展題目
        async function generateExpandTopic() {
            const prompt = categories["整合拓展"].topicPrompt;
            document.getElementById("expandTopicResult").innerHTML = "陳SIR正在出題...";
            try {
                const topic = await callAPI(prompt);
                const lines = topic.split("\n");
                if (lines.length < 2) throw new Error("API 回應格式不正確");
                const theme = lines[0].replace("主題句：", "").trim();
                const data = lines[1].replace("抄錄資料：", "").trim();
                if (!theme || !data) throw new Error("生成內容不完整");
                document.getElementById("expandTopicResult").innerHTML = `
                    主題句：<strong>${theme}</strong><br>
                    抄錄資料：<strong>${data}</strong>
                `;
                localStorage.setItem("expandCurrentTheme", theme);
                localStorage.setItem("expandCurrentData", data);
            } catch (error) {
                if (error.message === "所有 API 密鑰均無法使用") {
                    alert("今日 API 調用次數已用完或API無法連接，請明天再試");
                } else {
                    alert("生成題目時出錯，請重試");
                }
                document.getElementById("expandTopicResult").innerHTML = "";
            }
        }

        // 設定自訂題目
        function setExpandCustomTopic() {
            const title = document.getElementById("expandCustomTitle").value.trim();
            const theme = document.getElementById("expandCustomTheme").value.trim();
            const data = document.getElementById("expandCustomData").value.trim();
            if (!title || !theme || !data) {
                alert("請輸入所有內容");
                return;
            }
            document.getElementById("expandTopicResult").innerHTML = `
                題目：<strong>${title}</strong><br>
                主題句：<strong>${theme}</strong><br>
                抄錄資料：<strong>${data}</strong>
            `;
            localStorage.setItem("expandCurrentTitle", title);
            localStorage.setItem("expandCurrentTheme", theme);
            localStorage.setItem("expandCurrentData", data);
        }

        // 更新字數計數
        function updateCharCount() {
            const content = document.getElementById("expandContent").value;
            const remaining = 180 - content.length;
            document.getElementById("charCount").textContent = `剩餘字數：${remaining >= 0 ? remaining : 0}`;
            if (remaining < 0) {
                document.getElementById("expandContent").value = content.substring(0, 180);
            }
        }

        // 提交整合拓展內容
        async function submitExpand() {
            const expandFunction = document.getElementById("expandFunction").value;
            const title = localStorage.getItem("expandCurrentTitle");
            const theme = localStorage.getItem("expandCurrentTheme");
            const data = localStorage.getItem("expandCurrentData");

            if (!theme || !data) {
                alert("請先設定題目");
                return;
            }

            let prompt = "";
            if (expandFunction === "comment") {
                const content = document.getElementById("expandContent").value.trim();
                if (!content) {
                    alert("請輸入整合拓展內容");
                    return;
                }
                const note = categories["整合拓展"].commentNote;
                prompt = `請根據以下內容進行點評，要求：
1. 評估「整合拓展」是否能闡釋「抄錄資料」與「主題句」的邏輯關係
2. 判斷「拓展」方向是否正確（即是否能論證主題句）
3. 判斷推論是否嚴謹
4. 判斷是否具體不空泛
5. 若方向不正確，需指出並建議如何修訂，不能順著錯誤思路改善，需指導扣緊主題句
6. 改寫部份不超過180字，且不得虛構資料，只可根據抄錄資料補充合理細節
7. 輸出分為三個部分：### 點評、### 建議、### 改寫
8. 點評和建議以段落形式呈現，不使用列點

題目：${title || "無"}
主題句：${theme}
抄錄資料：${data}
整合拓展：${content}
教學筆記：${note}`;
            } else {
                const note = categories["整合拓展"].guideNote;
                prompt = `請根據以下題目、主題句和抄錄資料，生成三個問題，引導學生思考如何進行整合拓展。問題應能幫助學生分析資料與主題句的關係，並思考如何展開論述。
題目：${title || "無"}
主題句：${/\n/.test(theme) ? theme.split("\n")[0] : theme}
抄錄資料：${/\n/.test(data) ? data.split("\n")[0] : data}
教學筆記：${note}
請僅生成三個問題，每個問題占一行，不要包含其他內容。`;
            }

            document.getElementById("expandResult").innerHTML = expandFunction === "comment" ? "陳SIR正在點評..." : "陳SIR正在思考指引...";

            try {
                const result = await callAPI(prompt);
                if (expandFunction === "comment") {
                    const commentParts = result.split("###").map(part => part.trim()).filter(part => part);
                    let commentHTML = "<h3>陳SIR點評：</h3><table>";
                    commentParts.forEach(part => {
                        const [title, ...content] = part.split("\n").filter(line => line.trim());
                        commentHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
                    });
                    commentHTML += "</table>";
                    document.getElementById("expandResult").innerHTML = commentHTML;
                } else {
                    const questions = result.split("\n").map(q => q.trim()).filter(q => q);
                    if (questions.length !== 3) throw new Error("生成的問題數量不正確");
                    let guideHTML = "<h3>引導問題：</h3><ol>";
                    questions.forEach(question => guideHTML += `<li>${question}</li>`);
                    guideHTML += "</ol>";
                    document.getElementById("expandResult").innerHTML = guideHTML;
                }
            } catch (error) {
                if (error.message === "所有 API 密鑰均無法使用") {
                    alert("今日 API 調用次數已用完或API無法連接，請明天再試");
                } else {
                    alert("生成失敗，請重試");
                }
                document.getElementById("expandResult").innerHTML = "";
            }
        }

        // 通用 API 調用函數（保持不變）
        async function callAPI(prompt) {
            let attempts = 0;
            const maxAttempts = API_KEYS.length;
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    if (response.status === 429) {
                        currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                        attempts++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API 調用失敗: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                } catch (error) {
                    console.error(error);
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw new Error("所有 API 密鑰均無法使用");
                    }
                }
            }
        }

        // 其他功能代碼保持不變
    </script>
</body>
</html>
